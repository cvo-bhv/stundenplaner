<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sop√§dStundenplaner</title>
    
    <!-- EXTERN: Bibliotheken (Tailwind CSS, PDF.js, Icons) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- ####################################################### -->
    <!-- ### ABSCHNITT: DESIGN & CSS (Das Aussehen)          ### -->
    <!-- ####################################################### -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* GRUNDLAYOUT: Verhindert Wackeln der Seite */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            touch-action: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden;
        }

        /* SCROLLBALKEN DESIGN */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* AKTIVES FELD (Blauer Rahmen) */
        .active-cell {
            border: 3px solid #3b82f6 !important;
            background-color: #ffffff !important;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
            transform: scale(1.02);
            z-index: 50;
        }

        /* GESPERRTES FELD (Schraffiert) */
        .blocked-cell {
            background-image: repeating-linear-gradient(45deg, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.05) 10px, rgba(239, 68, 68, 0.15) 10px, rgba(239, 68, 68, 0.15) 20px);
            position: relative;
        }
        .blocked-cell::after {
            content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.5rem; color: rgba(239, 68, 68, 0.2); pointer-events: none; z-index: 0;
        }
        .blocked-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 2px dashed #f87171; pointer-events: none; z-index: 20; }

        .subject-btn { transition: all 0.1s; user-select: none; }
        .subject-btn:active { transform: scale(0.95); }

        /* EINTR√ÑGE (Die bunten "Chips" im Plan) */
        .entry-chip {
            border-radius: 4px; 
            font-weight: 600; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05); 
            width: 100%; 
            transition: all 0.2s; 
            position: relative; 
            z-index: 10; 
            cursor: pointer;
            padding: 2px; 
        }
        .entry-chip:not(.dimmed):hover { transform: scale(1.02); box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 30; }
        .entry-chip.dimmed { opacity: 0.3; filter: grayscale(100%); transform: scale(0.98); }
        .entry-chip.dimmed:hover { opacity: 0.8; filter: grayscale(0%); transform: scale(1.0); z-index: 30; }

        .chip-subject {
            font-size: 0.85rem; 
            line-height: 1;
            word-break: break-word; 
            max-width: 100%;
            font-weight: 800;
        }
        .chip-class {
            font-size: 0.65rem;
            line-height: 1;
            margin-top: 1px;
            opacity: 0.85;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* SPEZIAL-F√ÑCHER (WPF, F√ñA, ZUP etc.) */
        .global-chip {
            background-color: #334155 !important; 
            color: white !important;
            border: 2px solid #475569 !important;
            grid-column: 1 / -1 !important; 
            z-index: 40 !important;
        }
        .global-chip .chip-subject { font-size: 0.9rem; }
        .global-chip .chip-class { color: #cbd5e1 !important; font-size: 0.6rem; } 

        .global-chip.special-foea { background-color: #64748b !important; border-color: #475569 !important; color: #f1f5f9 !important; }
        .global-chip.special-foea .chip-subject { font-size: 0.75rem !important; }

        .global-chip.special-wpf { background-color: #e2e8f0 !important; border-color: #cbd5e1 !important; color: #334155 !important; }
        .global-chip.special-wpf .chip-subject { font-size: 0.7rem !important; }
        .global-chip.special-wpf .chip-class { color: #64748b !important; }
        .global-chip.special-wpf .magic-icon { background: rgba(0,0,0,0.1); color: #334155; }
        
        .global-chip.special-zup { background-color: #ffedd5 !important; border-color: #fdba74 !important; color: #9a3412 !important; }
        .global-chip.special-zup .chip-class { color: #c2410c !important; }
        .global-chip.special-zup .magic-icon { color: #ea580c !important; }

        /* MARKIERUNGEN (Gold f√ºr Auto, Gr√ºn f√ºr Fix) */
        .magic-selected { border: 2px solid #f59e0b !important; box-shadow: 0 0 8px rgba(245, 158, 11, 0.5); z-index: 25 !important; }
        .manual-selected { border: 2px solid #059669 !important; box-shadow: 0 0 8px rgba(5, 150, 105, 0.5); z-index: 26 !important; }

        .magic-icon {
            position: absolute; bottom: 2px; right: 2px; background: rgba(255, 255, 255, 0.95);
            border-radius: 50%; width: 12px; height: 12px; font-size: 8px;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            z-index: 20;
        }
        .magic-icon.auto { color: #b45309; }
        
        /* MINIBUTTONS IM FACH (L√∂schen / Pinnen) */
        .chip-btn {
            position: absolute; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-size: 9px; cursor: pointer; opacity: 0;
            transition: opacity 0.2s, background 0.2s, transform 0.1s; z-index: 50;
            background: rgba(255,255,255,0.9); box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .entry-chip:hover .chip-btn { opacity: 1; }
        .chip-btn.delete { top: 1px; left: 1px; color: #ef4444; }
        .chip-btn.delete:hover { background: #ef4444; color: white; transform: scale(1.1); }
        .chip-btn.pin { top: 1px; right: 1px; color: #cbd5e1; }
        .chip-btn.pin:hover { color: #10b981; transform: scale(1.1); }
        .chip-btn.pin.active { opacity: 1; color: #10b981; font-weight: bold; background: #ecfdf5; }

        /* UI ELEMENTE (Toast, Modal, etc.) */
        .toast {
            position: fixed; top: 20px; right: 20px; background: #10b981; color: white;
            padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0; transform: translateY(-20px); transition: all 0.3s; pointer-events: none; z-index: 200; font-weight: 600; display: flex; align-items: center;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #ef4444; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; z-index: 200;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: white; padding: 24px; border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 500px; width: 90%;
            max-height: 90vh; transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        /* SCHNELLAUSWAHL MEN√ú (Tastatur 1-9) */
        #quickSelectModal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 8px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 9999;
            display: none; width: 220px; border: 2px solid #3b82f6;
        }
        #quickSelectModal.show { display: block; animation: popIn 0.1s ease-out; }
        
        .quick-option {
            display: flex; align-items: center; padding: 8px; border-radius: 4px;
            cursor: pointer; transition: background 0.1s; margin-bottom: 2px;
            border: 1px solid transparent;
        }
        .quick-option:hover { background: #eff6ff; }
        .quick-option.selected { background: #dbeafe; border-color: #3b82f6; }

        .quick-key {
            background: #e2e8f0; color: #475569; font-weight: bold; font-size: 0.7rem;
            width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; margin-right: 8px;
        }
        
        @keyframes popIn { from { opacity: 0; transform: translate(-50%, -40%); } to { opacity: 1; transform: translate(-50%, -50%); } }

        /* HILFE & DRUCK STYLES */
        .help-content h3 { font-weight: bold; font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        .help-content ul, .help-content ol { padding-left: 1.2em; margin-bottom: 1em; }
        .help-content ul { list-style-type: disc; }
        .help-content ol { list-style-type: decimal; }
        
        .blocking-banner {
            display: none; background-color: #ef4444; color: white; text-align: center;
            padding: 10px; font-weight: bold; font-size: 0.9rem; border-radius: 8px 8px 0 0;
            margin-bottom: -1px; z-index: 50; animation: pulse-red 2s infinite;
        }
        body.blocking-active .blocking-banner { display: block; }
        body.blocking-active #mainTimetable { border: 4px solid #ef4444 !important; box-shadow: 0 0 20px rgba(239, 68, 68, 0.2); }
        @keyframes pulse-red { 0% { background-color: #ef4444; } 50% { background-color: #b91c1c; } 100% { background-color: #ef4444; } }

        /* SCAN & FOTO MODUS */
        .scan-controls {
            position: fixed; bottom: 20px; left: 20px; width: 280px;
            background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9000; display: none; padding: 16px; border: 1px solid #e5e7eb;
        }
        .scan-controls.show { display: block; }
        #scanImageLayer { position: absolute; left: 50%; top: 50%; transform-origin: center center; z-index: 0; pointer-events: none; max-width: none; }
        body.scan-active #mainTimetable { background: transparent !important; }
        body.scan-active .print-lesson, body.scan-active .print-break { background-color: rgba(255, 255, 255, 0.7) !important; position: relative; z-index: 10; }
        body.scan-active .time-col { background-color: rgba(248, 250, 252, 0.8) !important; position: relative; z-index: 10; }
        body.scan-active .print-lesson > div:not(.time-col) { background-color: transparent !important; position: relative; z-index: 10; }
        body.scan-active .active-cell { background-color: rgba(255, 255, 255, 0.3) !important; border: 3px solid rgba(59, 130, 246, 0.8) !important; }
        body.scan-active .entry-chip { opacity: 0.6 !important; }
        body.scan-active .entry-chip:hover { opacity: 0.95 !important; z-index: 100; }
        body.scan-adjust-mode #timetableBody { cursor: move; overflow: hidden !important; }

        /* TOUR OVERLAY */
        .tour-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9000; pointer-events: none; display: none; }
        .tour-overlay.active { display: block; }
        .tour-spotlight { position: absolute; border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); transition: all 0.4s ease-out; pointer-events: none; z-index: 9001; }
        .tour-tooltip { position: absolute; width: 340px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 9002; opacity: 0; transition: opacity 0.3s ease; pointer-events: auto; }
        .tour-tooltip.visible { opacity: 1; }

        /* DRUCK (PRINT) STYLES */
        @media print {
            @page { size: A4 landscape; margin: 1cm; }
            body > *:not(#printPreviewModal) { display: none !important; }
            #printPreviewModal { position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: white !important; display: block !important; opacity: 1 !important; z-index: 9999 !important; }
            #printPreviewModal .modal-box { box-shadow: none !important; width: 100% !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; transform: none !important; max-height: none !important; height: auto !important; overflow: visible !important; }
            #printPreviewContent { border: none !important; padding: 0 !important; width: 100% !important; height: 100% !important; overflow: visible !important; }
            .modal-actions, #printPreviewModal h3 { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        .print-table { width: auto; border-collapse: collapse; font-size: 10pt; font-family: Arial, sans-serif; table-layout: fixed; color: black; }
        .print-table th, .print-table td { border: 1px solid #000; text-align: center; padding: 0; vertical-align: middle; box-sizing: border-box; overflow: hidden; }
        .print-table thead th { background-color: #e2e8f0; font-weight: bold; height: 0.9cm !important; font-size: 11pt; }
        .print-table tbody tr { height: 1.561cm !important; } 
        .print-table tbody tr.break-row { height: 0.58cm !important; }
        .print-table th, .print-table td { width: 4.66cm !important; min-width: 4.66cm !important; max-width: 4.66cm !important; }
        .print-table .time-col, .print-table th.time-col { width: 1.3cm !important; min-width: 1.3cm !important; max-width: 1.3cm !important; background-color: white; font-weight: bold; font-size: 9pt; }
        .print-table .break-row td { background-color: #f1f5f9; font-size: 9pt; letter-spacing: 1px; text-transform: uppercase; color: #333; font-weight: bold; border-top: 1px double #000; border-bottom: 1px double #000; }
        
        .print-cell-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 1px; overflow: hidden; }
        .preview-subject { font-size: 12px; font-weight: 800; line-height: 1.1; word-break: break-word; text-align: center; }
        .preview-class { font-size: 9px; margin-top: 1px; line-height: 1; word-break: break-word; text-align: center; white-space: normal; }
        
        .doc-header-container { border-bottom: 2px solid #000; font-family: Arial, sans-serif; margin-bottom: 10px; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-end; }
        .doc-title { font-size: 24pt; font-weight: bold; margin: 0; color: #000; line-height: 1.2; }
        .doc-subtitle { font-size: 14pt; margin: 5px 0 0 0; color: #333; }
        .doc-date { font-size: 11pt; color: #333; }
    </style>
</head>
<body class="h-screen flex flex-row overflow-hidden text-gray-800 bg-gray-100 font-sans">

    <!-- ####################################################### -->
    <!-- ### ABSCHNITT: POPUPS & MODALE FENSTER              ### -->
    <!-- ####################################################### -->
    
    <div id="toast" class="toast"><i class="fas fa-check-circle mr-2"></i><span id="toastMsg">Erfolgreich!</span></div>

    <!-- L√∂schen Best√§tigung -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box" style="overflow-y: auto;">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Best√§tigung</h3>
            <p id="confirmText" class="text-gray-600 mb-6">Sind Sie sicher?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfirm(false)" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Abbrechen</button>
                <button onclick="closeConfirm(true)" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded font-bold">Ja, L√∂schen</button>
            </div>
        </div>
    </div>
    
    <!-- SCHNELLAUSWAHL (Das kleine Men√º) -->
    <div id="quickSelectModal">
        <div id="quickSelectContent"></div>
        <div class="text-[9px] text-gray-400 mt-2 border-t pt-1 text-center flex justify-between">
            <span>Enter = W√§hlen</span>
            <span>1-9</span>
        </div>
    </div>

    <!-- SCAN KONTROLLEN (Unten links) -->
    <div id="scanControls" class="scan-controls">
        <div class="flex justify-between items-center mb-4">
            <h4 class="font-bold text-gray-800 text-sm"><i class="fas fa-camera mr-2 text-blue-500"></i>Scan-Vorlage anpassen</h4>
        </div>
        <p class="text-[10px] text-gray-500 mb-3 leading-tight">1. Schiebe das Bild direkt mit dem Finger.<br>2. Zoome mit zwei Fingern.<br>3. Klicke "Fertig" zum Fixieren.</p>
        
        <div class="space-y-3">
            <div>
                <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">Transparenz Plan</label>
                <input type="range" min="0" max="100" value="70" id="scanOpacitySlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateScanOpacity(this.value)">
            </div>
            <div>
                <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">Gr√∂√üe (Zoom)</label>
                <input type="range" min="20" max="500" value="100" id="scanZoomSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateScanZoom(this.value)">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">X-Pos</label>
                    <input type="range" min="-500" max="500" value="0" id="scanXSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateScanX(this.value)">
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">Y-Pos</label>
                    <input type="range" min="-500" max="500" value="0" id="scanYSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateScanY(this.value)">
                </div>
            </div>
            <div>
                <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">Drehen (¬∞)</label>
                <input type="range" min="-180" max="180" value="0" id="scanRotateSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateScanRotation(this.value)">
            </div>
             <div class="pt-3 border-t border-gray-100 flex flex-col gap-2">
                 <button onclick="finishScanAdjustment()" class="w-full text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow-sm">Fertig & Fixieren</button>
                 <div class="flex gap-2">
                    <button onclick="document.getElementById('scanImportFile').click()" class="flex-1 text-xs bg-gray-50 border border-gray-200 hover:bg-white text-gray-600 py-1.5 rounded">Neues Bild</button>
                    <button onclick="removeScan()" class="flex-1 text-xs bg-red-50 border border-red-200 hover:bg-red-100 text-red-600 py-1.5 rounded">Bild l√∂schen</button>
                 </div>
             </div>
        </div>
    </div>
    
    <div id="reopenScanBtn" class="fixed bottom-5 left-5 z-50 hidden">
        <button onclick="reopenScanAdjustment()" class="bg-white border border-purple-200 text-purple-600 hover:bg-purple-50 shadow-lg px-3 py-2 rounded-full text-xs font-bold flex items-center gap-2">
            <i class="fas fa-camera"></i> Scan anpassen
        </button>
    </div>

    <!-- TOUR OVERLAY -->
    <div id="tourOverlay" class="tour-overlay">
        <div id="tourSpotlight" class="tour-spotlight"></div>
        <div id="tourTooltip" class="tour-tooltip">
            <div class="flex justify-between items-start mb-2">
                <h3 id="tourTitle" class="font-bold text-lg text-gray-800">Willkommen!</h3>
                <button onclick="endTour()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <p id="tourText" class="text-sm text-gray-600 mb-4 leading-relaxed">Hier ist eine kurze Einf√ºhrung.</p>
            <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                <label class="flex items-center text-xs text-gray-500 cursor-pointer">
                    <input type="checkbox" id="tourDontShowAgain" class="mr-1 rounded text-blue-500"> Nicht mehr anzeigen
                </label>
                <div class="flex gap-2">
                    <button onclick="endTour()" class="text-xs text-gray-500 hover:text-gray-800 px-2 py-1">Beenden</button>
                    <button onclick="nextTourStep()" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded font-bold">Weiter</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- DRUCK VORSCHAU MODAL -->
    <div id="printPreviewModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><i class="fas fa-print mr-2 text-blue-500"></i> Druckvorschau</h3>
            <div id="printPreviewContent"></div>
            <div class="flex justify-end gap-3 mt-4 modal-actions">
                <button onclick="document.getElementById('printPreviewModal').classList.remove('show')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Schlie√üen</button>
                <button onclick="window.print()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow-md"><i class="fas fa-print mr-2"></i> Drucken</button>
            </div>
        </div>
    </div>

    <!-- ERGEBNIS / STATISTIK MODAL -->
    <div id="resultModal" class="modal-overlay">
        <div class="modal-box max-w-lg" style="overflow-y: auto;">
            <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><i class="fas fa-chart-pie mr-2 text-amber-500"></i> Verteilungsergebnis</h3>
            <div id="resultContent" class="text-gray-600 mb-6 text-sm max-h-[60vh] overflow-y-auto pr-2"></div>
            <div class="flex justify-end"><button onclick="closeResult()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow-md">OK, Danke</button></div>
        </div>
    </div>

    <!-- F√ÑCHER EINSTELLUNGEN MODAL -->
    <div id="magicSettingsModal" class="modal-overlay">
        <div class="modal-box max-w-lg flex flex-col max-h-[85vh]">
            <div class="flex-shrink-0">
                <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center"><i class="fas fa-cogs mr-2 text-gray-500"></i> F√§cher verwalten</h3>
                <p class="text-sm text-gray-500 mb-4 leading-relaxed">
                    <strong>Wof√ºr ist das?</strong> Hier definierst du deinen pers√∂nlichen F√§cher-Pool.<br>
                    üëÅÔ∏è <strong>Auge:</strong> Zeigt das Fach in der linken Seitenleiste an.<br>
                    ‚ú® <strong>Haken:</strong> Dieses Fach wird beim Klick auf "Auto" automatisch verteilt.
                </p>
                <div class="flex gap-2 mb-2 bg-gray-50 p-2 rounded border border-gray-200">
                    <input type="text" id="newSubjectInput" placeholder="Suchen oder neu..." class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500" onkeypress="handleNewSubjectEnter(event)" oninput="filterMagicSettings(this.value)">
                    <button onclick="addNewSubject()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold"><i class="fas fa-plus"></i></button>
                </div>
                <div class="flex gap-2 mb-4">
                    <button onclick="deselectAllMagic()" class="flex-1 bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 py-1.5 rounded text-xs font-bold shadow-sm transition"><i class="fas fa-square mr-1"></i> Auto-Auswahl aufheben</button>
                    <button onclick="showAllSubjects()" class="flex-1 bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 py-1.5 rounded text-xs font-bold shadow-sm transition"><i class="fas fa-eye mr-1"></i> Alle einblenden</button>
                </div>
                <div class="flex justify-between items-center px-2 mb-2 text-xs font-bold text-gray-500 border-b border-gray-100 pb-1">
                    <span class="uppercase">Fachname</span>
                    <div class="flex items-center gap-4 mr-8">
                        <span title="Sichtbar" class="w-6 text-center text-base"><i class="fas fa-eye"></i></span>
                        <span title="Auto-Verteilung" class="w-4 text-center text-base"><i class="fas fa-check-square"></i></span>
                    </div>
                </div>
            </div>
            <div id="magicSettingsList" class="space-y-1 mb-4 overflow-y-auto flex-1 min-h-0 pr-2 border-t border-b border-gray-50 py-2"></div>
            <div class="flex-shrink-0 flex justify-end gap-3 mt-auto">
                <button onclick="closeMagicSettings()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold w-full sm:w-auto">Fertig</button>
            </div>
        </div>
    </div>

    <!-- REGELN MODAL -->
    <div id="rulesModal" class="modal-overlay">
        <div class="modal-box max-w-xl" style="overflow-y: auto;">
            <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center"><i class="fas fa-list-ol mr-2 text-blue-500"></i> Regeln</h3>
            <p class="text-sm text-gray-500 mb-4 leading-relaxed">Hier kannst du der Automatik feste Vorgaben geben. <br><em>Beispiel:</em> "Die Klasse 6a braucht zwingend 4 Stunden Mathe", "Maximal 5 Stunden in Klasse 6b" oder "Maximal 2 Stunden Sport in 6a".</p>
            <div class="flex gap-2 mb-4 items-end bg-gray-50 p-2 rounded border border-gray-200">
                <div class="w-24">
                    <label class="block text-[10px] uppercase text-gray-500 font-bold mb-1">Typ</label>
                    <select id="ruleTypeSelect" class="w-full text-sm border-gray-300 rounded p-1" onchange="updateRuleTypeUI()">
                        <option value="min">Fach (Min)</option>
                        <option value="max_subject">Fach (Max)</option>
                        <option value="max">Klasse (Max)</option>
                    </select>
                </div>
                <div class="flex-1"><label class="block text-[10px] uppercase text-gray-500 font-bold mb-1">Klasse</label><select id="ruleClassSelect" class="w-full text-sm border-gray-300 rounded p-1"></select></div>
                <div class="flex-1" id="ruleSubjectContainer"><label class="block text-[10px] uppercase text-gray-500 font-bold mb-1">Fach</label><select id="ruleSubjectSelect" class="w-full text-sm border-gray-300 rounded p-1"></select></div>
                <div class="w-16"><label class="block text-[10px] uppercase text-gray-500 font-bold mb-1">Std.</label><input type="number" id="ruleCountInput" value="1" min="1" max="10" class="w-full text-sm border-gray-300 rounded p-1"></div>
                <button onclick="addRule()" class="bg-green-500 text-white px-3 py-1.5 rounded hover:bg-green-600"><i class="fas fa-plus"></i></button>
            </div>
            <div id="ruleList" class="space-y-2 mb-6 max-h-[30vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-3"><button onclick="closeRulesModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Schlie√üen</button></div>
        </div>
    </div>

    <!-- HILFE MODAL -->
    <div id="helpModal" class="modal-overlay">
        <div class="modal-box max-w-2xl" style="overflow-y: auto;">
            <h3 class="text-xl font-bold text-gray-800 mb-2 flex items-center border-b pb-2"><i class="fas fa-book-reader mr-2 text-blue-500"></i> Anleitung</h3>
            <div class="help-content overflow-y-auto max-h-[60vh] pr-2 text-sm space-y-4">
                <section>
                    <h3>1. Der Start: Wer bist du? üìù</h3>
                    <p>Ganz oben findest du die Leiste f√ºr deine <strong>Pers√∂nlichen Daten</strong>. Trage dort deinen Namen, K√ºrzel, Jahrgang und das Schuljahr ein. Diese Infos erscheinen sp√§ter sch√∂n formatiert auf deinem Ausdruck.</p>
                </section>
                <section>
                    <h3>2. Klassen anlegen üè´</h3>
                    <p>Rechts daneben erstellst du deine Klassen. Tippe einfach den Namen (z.B. <code>6a</code>) ein und dr√ºcke <strong>Enter</strong> oder auf das <strong>+</strong>. Die Klassen erscheinen dann als kleine Buttons in der Leiste.</p>
                </section>
                <section>
                    <h3>3. Der Stundenplan: Manuelle Eingabe ‚úçüèª</h3>
                    <p>W√§hle zuerst oben eine Klasse aus (sie wird farbig markiert). Klicke dann links in der Leiste auf ein <strong>Fach</strong>. Der Planer f√ºllt automatisch das n√§chste freie Feld. <br>
                    <em>Tipp:</em> Du kannst auch direkt in ein Feld im Stundenplan klicken (es wird blau umrandet) und dann ein Fach ausw√§hlen, um genau dort etwas einzutragen.</p>
                </section>
                <section>
                    <h3>NEU: Power-User Tastatur ‚å®Ô∏è</h3>
                    <p>Arbeite schneller mit der Tastatur:</p>
                    <ul class="list-disc pl-5 mt-1">
                        <li><strong>F√§cher:</strong> Dr√ºcke den Anfangsbuchstaben (z.B. 'M' f√ºr Mathe). Gibt es mehrere (z.B. 'E' f√ºr ENG/ENG-E), erscheint ein Auswahlmen√º. W√§hle mit 1-9.</li>
                        <li><strong>Pfeiltasten:</strong> Navigiere durch den Plan.</li>
                        <li><strong>Enter:</strong> Springt zum n√§chsten Feld (am Ende des Tages zum n√§chsten Tag).</li>
                        <li><strong>Delete/Backspace:</strong> L√∂scht den Eintrag im aktiven Feld.</li>
                    </ul>
                </section>
                <section>
                    <h3>NEU: Scan-Vorlage üì∑</h3>
                    <p>Du hast einen alten Plan als Bild? Klicke oben auf das <strong>Kamera-Icon</strong>.</p>
                    <ul class="list-disc pl-5 mt-1">
                        <li><strong>Anpassungs-Modus:</strong> Lade ein Bild (oder PDF!) hoch. Der Plan wird gesperrt (das Scrollen stoppt), damit du das Bild <strong>direkt mit dem Finger/Maus</strong> an die richtige Stelle schieben kannst.</li>
                        <li><strong>Eingabe-Modus:</strong> Klicke auf "Fertig & Fixieren". Jetzt kannst du wie gewohnt F√§cher eintragen ‚Äì dein Bild bleibt transparent im Hintergrund liegen.</li>
                    </ul>
                </section>
                <section>
                    <h3>4. Korrigieren & Fixieren üìå</h3>
                    <p>Hier hast du die volle Kontrolle:</p>
                    <ul class="list-disc pl-5 mt-1">
                        <li><strong>L√∂schen (X):</strong> Fahre mit der Maus √ºber ein Fach im Plan. Oben links erscheint ein rotes <strong>X</strong>. Ein Klick, und das Fach ist weg.</li>
                        <li><strong>Pinnen (Fixieren):</strong> Oben rechts im Fach siehst du eine Nadel. Klicke sie an, damit sie <strong>gr√ºn</strong> wird. Das bedeutet: "Dieses Fach ist heilig!". Die Automatik wird es <strong>nicht</strong> verschieben. Perfekt f√ºr feste Termine.</li>
                        <li><strong>√Ñndern:</strong> Klicke ein Feld an (blauer Rahmen) und w√§hle ein anderes Fach, um es auszutauschen.</li>
                    </ul>
                </section>
                <section>
                    <h3>5. Die Automatik & Konfiguration ‚öôÔ∏è</h3>
                    <p>Bevor du die Magie startest:</p>
                    <ul class="list-disc pl-5 mt-1">
                        <li><strong>Sperren (‚õî):</strong> Klicke auf den "Sperren"-Button und markiere Zeiten im Plan, an denen du gar nicht kannst.</li>
                        <li><strong>F√§cher-Pool (Zahnrad):</strong> W√§hle hier aus, welche F√§cher √ºberhaupt verteilt werden sollen.</li>
                        <li><strong>Regeln:</strong> Definiere Zw√§nge wie "Klasse 6a muss 2x Mathe haben".</li>
                    </ul>
                    <p class="mt-2">Alles bereit? Klicke auf <strong>Auto</strong>. Der Algorithmus berechnet nun fair die Verteilung. Das Ergebnis siehst du sofort in der Statistik.</p>
                </section>
                <section>
                    <h3>6. Abschluss & Export üñ®Ô∏è</h3>
                    <p>Nach der Automatik kannst du nat√ºrlich noch manuell eingreifen und F√§cher verschieben. Wenn alles passt:</p>
                    <ul class="list-disc pl-5 mt-1">
                        <li><strong>Drucken:</strong> Erzeugt eine saubere PDF-Ansicht.</li>
                        <li><strong>Speichern (Diskette):</strong> Speichert den aktuellen Stand als Datei auf deinem PC, damit du sp√§ter weitermachen kannst.</li>
                    </ul>
                </section>
            </div>
            <div class="flex justify-end mt-2">
                <button onclick="startTour()" class="px-4 py-2 border border-blue-600 text-blue-600 hover:bg-blue-50 rounded font-bold mr-2">Tour starten</button>
                <button onclick="document.getElementById('helpModal').classList.remove('show')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow-md">Verstanden</button>
            </div>
        </div>
    </div>

    <!-- ####################################################### -->
    <!-- ### ABSCHNITT: LINKES MEN√ú (Sidebar)                ### -->
    <!-- ####################################################### -->
    
    <aside class="w-80 bg-white shadow-xl z-30 flex flex-col h-full border-r border-gray-200 flex-shrink-0 no-print" style="overflow: hidden;">
        <div class="p-3 border-b border-gray-100 bg-gray-50 flex-shrink-0">
            <div class="flex flex-col mb-2">
                <h1 class="text-lg font-bold text-gray-800 flex items-center mb-1"><i class="fas fa-layer-group text-blue-600 mr-2"></i> Sop√§dStundenplaner</h1>
                
                <!-- TOOLBAR (Speichern, Laden, Drucken Buttons) -->
                <div class="flex gap-1 justify-end w-full" id="toolbarActions">
                    <button onclick="exportToFile()" class="text-emerald-600 hover:bg-emerald-100 p-1.5 rounded transition" title="Speichern"><i class="fas fa-save"></i></button>
                    <button onclick="document.getElementById('importFile').click()" class="text-blue-600 hover:bg-blue-100 p-1.5 rounded transition" title="Laden"><i class="fas fa-folder-open"></i></button>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importFromFile(this)">
                    
                    <button onclick="document.getElementById('scanImportFile').click()" class="text-purple-600 hover:bg-purple-100 p-1.5 rounded transition" title="Scan-Vorlage laden"><i class="fas fa-camera"></i></button>
                    <input type="file" id="scanImportFile" class="hidden" accept="image/*,.pdf" onchange="handleScanUpload(this)">
                    
                    <button onclick="requestClearTimetable()" class="text-red-500 hover:bg-red-100 p-1.5 rounded transition" title="L√∂schen"><i class="fas fa-trash-alt"></i></button>
                    <button onclick="openPrintPreview()" class="text-gray-600 hover:bg-gray-200 p-1.5 rounded transition" title="Drucken"><i class="fas fa-print"></i></button>
                    <button onclick="document.getElementById('helpModal').classList.add('show')" class="text-blue-500 hover:bg-blue-100 p-1.5 rounded transition" title="Hilfe"><i class="fas fa-question-circle"></i></button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar Inhalt (Scrollbar) -->
        <div class="flex-1 overflow-y-auto p-3 space-y-4 custom-scroll" id="sidebarScrollArea">
            
            <!-- STUNDEN & KONFIG -->
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-2" id="targetHoursSection">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-bold text-amber-800 uppercase">Unterrichtsstunden</span>
                    <input type="number" id="teacherHours" value="27" min="1" max="40" onchange="updateLiveStats()" class="w-12 text-sm text-center border border-amber-300 rounded bg-white">
                </div>
                <div class="text-[9px] text-amber-800 mb-1 opacity-80 text-center font-medium">Konfiguration: Sperren, Regeln, F√§cher & Bericht</div>
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <button id="blockToggleBtn" onclick="toggleBlockingMode()" class="bg-white border border-red-300 text-red-500 hover:bg-red-50 p-1.5 rounded text-xs flex justify-center" title="Sperren"><i class="fas fa-ban"></i></button>
                    <button id="btnRules" onclick="openRulesModal()" class="bg-white border border-blue-300 text-blue-600 hover:bg-blue-50 p-1.5 rounded text-xs flex justify-center" title="Regeln"><i class="fas fa-list-ol"></i></button>
                    <button id="btnMagicSettings" onclick="openMagicSettings()" class="bg-white border border-amber-300 text-amber-600 hover:bg-amber-50 p-1.5 rounded text-xs flex justify-center" title="F√§cher"><i class="fas fa-cog"></i></button>
                    <button onclick="reopenResult()" class="bg-white border border-amber-300 text-amber-600 hover:bg-amber-50 p-1.5 rounded text-xs flex justify-center" title="Bericht"><i class="fas fa-chart-bar"></i></button>
                </div>
                <div class="flex gap-2" id="autoButtonSection">
                    <button onclick="runMagicAlgorithm()" class="flex-1 bg-gradient-to-r from-amber-400 to-orange-500 hover:from-amber-500 hover:to-orange-600 text-white py-1.5 rounded text-xs font-bold shadow-sm transition"><i class="fas fa-magic mr-1"></i> Auto</button>
                    <button onclick="clearMagicSelection()" class="px-2 text-xs text-amber-700 underline hover:text-amber-900">Reset</button>
                </div>
            </div>

            <!-- F√ÑCHER LISTE -->
            <div id="subjectSection">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-bold text-gray-500 uppercase">F√§cher</span>
                    <span id="selectedClassDisplay" class="text-xs font-bold text-blue-600 h-4"></span>
                </div>
                <div class="grid grid-cols-4 gap-1" id="subjectGrid"></div>
            </div>

            <!-- NAVIGATIONSTASTEN -->
            <div>
                <span class="text-xs font-bold text-gray-500 uppercase block mb-2">Navigation</span>
                <div class="flex flex-wrap gap-1">
                    <button onclick="setCursor(0, 1)" class="flex-1 bg-white border border-gray-300 rounded py-1 text-xs hover:bg-gray-50">Mo</button>
                    <button onclick="setCursor(1, 1)" class="flex-1 bg-white border border-gray-300 rounded py-1 text-xs hover:bg-gray-50">Di</button>
                    <button onclick="setCursor(2, 1)" class="flex-1 bg-white border border-gray-300 rounded py-1 text-xs hover:bg-gray-50">Mi</button>
                    <button onclick="setCursor(3, 1)" class="flex-1 bg-white border border-gray-300 rounded py-1 text-xs hover:bg-gray-50">Do</button>
                    <button onclick="setCursor(4, 1)" class="flex-1 bg-white border border-gray-300 rounded py-1 text-xs hover:bg-gray-50">Fr</button>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="clearActiveCell()" class="flex-1 bg-white border border-red-200 text-red-500 rounded py-1 text-xs hover:bg-red-50"><i class="fas fa-eraser"></i> Feld</button>
                    <button id="demoDataBtn" onclick="fillTestSchedule()" class="flex-1 bg-rose-50 text-rose-600 border border-rose-200 rounded py-1 text-xs hover:bg-rose-100"><i class="fas fa-flask"></i> Demo</button>
                </div>
            </div>
        </div>

        <!-- STATISTIK FOOTER -->
        <div class="p-3 bg-slate-50 border-t border-gray-200 flex-shrink-0 mt-auto" id="statsFooter" data-position="bottom">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-slate-700 uppercase flex items-center gap-2">
                    Verteilung 
                    <button onclick="toggleStatsPosition()" class="text-gray-400 hover:text-blue-600 transition-transform duration-200" title="Verschieben"><i id="statsPositionArrow" class="fas fa-chevron-up"></i></button>
                </span>
                <span id="totalAssignedBadge" class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">0/27</span>
            </div>
            <div id="liveStatsContent" class="text-xs text-gray-600 max-h-32 overflow-y-auto pr-1"><p class="text-gray-400 italic text-center py-2">Leer</p></div>
        </div>
    </aside>

    <!-- #######################################################
    <!-- ### ABSCHNITT: HAUPT-BEREICH (Stundenplan)          ### -->
    <!-- ####################################################### -->
    
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-gray-100 p-4 print:p-0">
        <!-- Obere Leiste (Klassen, Name) -->
        <div id="topBar" class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 mb-3 flex flex-col gap-3 flex-shrink-0 print:hidden z-20">
            <div class="flex gap-4 items-start">
                <div class="flex-1 border-r border-gray-100 pr-4" id="personalDataSection">
                    <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Pers√∂nliche Daten</label>
                    <div class="flex gap-2">
                        <input type="text" id="teacherNameInput" placeholder="Name" class="flex-[2] border border-gray-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-blue-500">
                        <input type="text" id="gradeLevelInput" placeholder="Jahrg." class="flex-1 w-16 border border-gray-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-blue-500">
                        <input type="text" id="schoolYearInput" placeholder="Schuljahr" class="flex-1 w-20 border border-gray-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="flex-1" id="classInputSection">
                    <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Neue Klasse</label>
                    <div class="flex gap-1">
                        <input type="text" id="classInput" placeholder="z.B. 6a..." class="flex-1 border border-gray-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-blue-500" onkeypress="handleClassEnter(event)">
                        <button onclick="addClass()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
            <div id="classList" class="flex flex-wrap gap-2 min-h-[32px] items-center pt-1 border-t border-gray-50">
                <span class="text-gray-400 text-xs italic">Keine Klassen...</span>
            </div>
        </div>
        <div id="blockingBanner" class="blocking-banner flex-shrink-0">
            <i class="fas fa-hand-paper mr-2"></i>SPERR-MODUS AKTIV - Markiere die Fl√§chen, in denen du nicht arbeiten kannst
        </div>

        <!-- Stundenplan Tabelle -->
        <div id="mainTimetable" class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-300 flex-1 flex flex-col print:border-none print:shadow-none min-h-0">
            <div id="timetableHeader" class="grid grid-cols-[60px_1fr_1fr_1fr_1fr_1fr] bg-slate-800 text-white text-center font-bold text-sm shadow-md z-10 flex-shrink-0 transition-colors duration-300">
                <div class="p-2 border-r border-slate-600/30">Zeit</div>
                <div class="p-2 border-r border-slate-600/30">Mo</div>
                <div class="p-2 border-r border-slate-600/30">Di</div>
                <div class="p-2 border-r border-slate-600/30">Mi</div>
                <div class="p-2 border-r border-slate-600/30">Do</div>
                <div class="p-2">Fr</div>
            </div>
            <!-- Stundenplan Body -->
            <div id="timetableBody" class="text-sm overflow-y-auto flex-1 bg-white custom-scroll pb-32"></div>
        </div>
        <div class="text-center text-gray-400 text-[10px] mt-2 no-print flex-shrink-0">
            <span class="font-bold text-amber-600">Gold (üéì)</span> = Auto. <span class="font-bold text-emerald-600 ml-1">Gr√ºn (üìå)</span> = Fix. <span class="font-bold text-red-500 ml-1">Schraffiert (‚õî)</span> = Gesperrt.
        </div>
    </main>

    <!-- ####################################################### -->
    <!-- ### ABSCHNITT: JAVASCRIPT LOGIK                     ### -->
    <!-- ####################################################### -->
    <script>
        // --- HILFSFUNKTIONEN (M√ºssen am Anfang stehen) ---
        function addEntry(cellId, subject, clsObj) { 
            let entries = timetableData[cellId] || []; 
            entries.push({ subject: subject, className: clsObj.name, colorClass: clsObj.colorClass, isMagicSelected: false, isManual: false }); 
            timetableData[cellId] = entries; 
        }

        // #######################################################
        // ### ABSCHNITT: KONFIGURATION & BASIS-DATEN          ###
        // #######################################################
        let allSubjects = [
            "BIO", "BSO", "CARE", "CHE-E", "CHE-G", "DEU", "DEU-E", "DEU-G", 
            "ENG", "ENG-E", "ENG-G", "F√ñA", "GGP", "GSE", "IPAD", "KS", "KUN", 
            "MAT", "MAT-E", "MAT-G", "MEN", "MUS", "NAT", "PHY-E", "PHY-G", 
            "RAT", "REL", "SOL", "SOZ", "SPA", "SPO", "TUE", "WAT", "WPF", "ZUP", "---"
        ];
        
        const subjectColors = {
            "BIO": "#6BE5C3", "BSO": "#D97C34", "CARE": "#C4A661", "CHE-E": "#9B30FF",
            "CHE-G": "#702090", "DEU": "#D97C34", "DEU-E": "#3B5CD7", "DEU-G": "#8B5742",
            "ENG": "#9D4EDD", "ENG-E": "#6E8B3D", "ENG-G": "#245837", "F√ñA": "#BD805C",
            "GGP": "#E0C3FC", "GSE": "#9CCF5E", "IPAD": "#C4A661", "KS": "#5AFF5A",
            "KUN": "#1A4035", "MAT": "#5AFF5A", "MAT-E": "#BA3628", "MAT-G": "#245837",
            "MEN": "#F53DF5", "MUS": "#D1458F", "NAT": "#7B92B6", "PHY-E": "#D040B0",
            "PHY-G": "#4B70C0", "RAT": "#3B5CD7", "REL": "#D97C34", "SOL": "#D97C34",
            "SOZ": "#D97C34", "SPA": "#D97C34", "SPO": "#682568", "TUE": "#BD805C",
            "WAT": "#BA3628", "WPF": "#5D6D7E", "ZUP": "#C46F3A"
        };
        
        const GLOBAL_SUBJECTS = ["F√ñA", "WPF", "SPA", "TUE", "MEN", "ZUP"];
        
        const classColors = [
            'bg-red-200 text-red-900 border-red-300',         
            'bg-blue-200 text-blue-900 border-blue-300',      
            'bg-green-200 text-green-900 border-green-300',   
            'bg-amber-200 text-amber-900 border-amber-300',   
            'bg-purple-200 text-purple-900 border-purple-300', 
            'bg-cyan-200 text-cyan-900 border-cyan-300'        
        ];
        
        const scheduleStructure = [ { id: 1, type: 'lesson', start: '08:05', end: '08:50' }, { id: 2, type: 'lesson', start: '08:50', end: '09:35' }, { type: 'break', start: '09:35', end: '09:55', label: 'Pause' }, { id: 3, type: 'lesson', start: '09:55', end: '10:40' }, { id: 4, type: 'lesson', start: '10:40', end: '11:25' }, { type: 'break', start: '11:25', end: '11:45', label: 'Pause' }, { id: 5, type: 'lesson', start: '11:45', end: '12:30' }, { id: 6, type: 'lesson', start: '12:30', end: '13:15' }, { type: 'break', start: '13:15', end: '13:30', label: 'Pause' }, { id: 7, type: 'lesson', start: '13:30', end: '14:15' }, { id: 8, type: 'lesson', start: '14:50', end: '15:00' } ];

        // --- STATUS VARIABLEN ---
        let classes = []; let selectedClassIndex = -1; let timetableData = {}; let blockedSlots = new Set(); let cursor = { day: 0, period: 1 }; let isBlockingMode = false; let magicSubjectKeys = ["MAT", "DEU", "ENG"]; let magicRules = []; let lastResultData = null; let confirmCallback = null;
        let hiddenSubjects = new Set();
        let isQuickSelectOpen = false;
        let quickSelectOptions = [];
        let quickSelectIndex = 0; 
        
        // Scan State
        let scanImage = null;
        let scanSettings = { zoom: 100, x: 0, y: 0, rotation: 0 }; 
        let isScanAdjustmentMode = false; 
        
        // Scan Drag & Drop State
        let isDraggingScan = false;
        let isPinching = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let initialScanX = 0;
        let initialScanY = 0;
        let pinchStartDist = 0;
        let pinchStartZoom = 100;

        // #######################################################
        // ### ABSCHNITT: HILFS-FUNKTIONEN                     ###
        // #######################################################
        function getColorForClass(className) {
            const lastChar = className.slice(-1).toLowerCase();
            const map = { 'a': 0, 'b': 1, 'c': 2, 'd': 3, 'e': 4, 'f': 5 };
            if (map.hasOwnProperty(lastChar)) { return classColors[map[lastChar]]; }
            let hash = 0; for (let i = 0; i < className.length; i++) hash = className.charCodeAt(i) + ((hash << 5) - hash);
            return classColors[Math.abs(hash) % classColors.length];
        }

        function showToast(msg, isError = false) { const t = document.getElementById('toast'); const tm = document.getElementById('toastMsg'); tm.textContent = msg; t.className = isError ? 'toast error show' : 'toast show'; setTimeout(() => { t.classList.remove('show'); }, 3000); }
        function requestClearTimetable() { 
            disableBlockingMode(); 
            document.getElementById('confirmText').textContent = "M√∂chtest du wirklich den gesamten Stundenplan l√∂schen?"; document.getElementById('confirmModal').classList.add('show'); confirmCallback = () => { timetableData = {}; blockedSlots = new Set(); lastResultData = null; magicRules = []; ensureZUP(); renderTimetable(); updateLiveStats(); showToast("Plan gel√∂scht."); }; 
        }
        function closeConfirm(result) { document.getElementById('confirmModal').classList.remove('show'); if (result && confirmCallback) confirmCallback(); confirmCallback = null; }
        
        function ensureZUP() {
            const zupId = 'd2-p5';
            if (!timetableData[zupId] || !timetableData[zupId].some(e => e.subject === 'ZUP')) {
                timetableData[zupId] = []; 
                timetableData[zupId].push({ 
                    subject: "ZUP", 
                    className: "", 
                    colorClass: "special-zup", 
                    isMagicSelected: false, 
                    isManual: true 
                });
            }
        }

        // #######################################################
        // ### ABSCHNITT: DATEI EXPORT/IMPORT & DRUCK          ###
        // #######################################################
        function openPrintPreview() {
            disableBlockingMode();
            updateHeaderColor('neutral');
            let html = '';
            const name = document.getElementById('teacherNameInput').value || '_______________';
            const grade = document.getElementById('gradeLevelInput').value || '____';
            const year = document.getElementById('schoolYearInput').value || '____';
            const currentDate = new Date().toLocaleDateString('de-DE'); 

            html += `<div class="doc-header-container"><div><div class="doc-title">Stundenplan</div><div class="doc-subtitle">Lehrkraft: ${name} | Jahrgang: ${grade} | Schuljahr: ${year}</div></div><div class="doc-date">${currentDate}</div></div>`;
            html += '<table class="print-table"><thead><tr><th class="time-col">Zeit</th>';
            ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'].forEach(day => html += `<th>${day}</th>`);
            html += '</tr></thead><tbody>';

            scheduleStructure.forEach(slot => {
                if (slot.type === 'break') {
                    html += `<tr class="break-row"><td class="time-col" style="text-align:center;">-</td><td colspan="5">PAUSE (${slot.start} - ${slot.end})</td></tr>`;
                } else {
                    html += `<tr class="content-row"><td class="time-col">${slot.id}.<br><span style="font-weight:normal; font-size:9pt;">${slot.start}<br>${slot.end}</span></td>`;
                    for (let day = 0; day < 5; day++) {
                        const cellId = `d${day}-p${slot.id}`;
                        const entries = timetableData[cellId] || [];
                        const selectedEntries = entries.filter(e => e.isMagicSelected || e.isManual);
                        let cellContent = '';
                        let globalEntry = selectedEntries.find(e => GLOBAL_SUBJECTS.includes(e.subject));
                        if (globalEntry) {
                             let subText = classes.map(c => c.name).join(', ');
                             if (globalEntry.subject === 'ZUP') subText = 'Teamsitzung';
                             let styleClass = 'global-chip';
                             if (globalEntry.subject === 'F√ñA') styleClass += ' special-foea';
                             else if (['WPF', 'SPA', 'TUE'].includes(globalEntry.subject)) styleClass += ' special-wpf';
                             else if (globalEntry.subject === 'ZUP') styleClass += ' special-zup';
                             cellContent = `<div class="print-cell-content ${styleClass}"><span class="preview-subject">${globalEntry.subject}</span><span class="preview-class">${subText}</span></div>`;
                        } else if (selectedEntries.length > 0) {
                            const e = selectedEntries[0];
                            cellContent = `<div class="print-cell-content ${e.colorClass}"><span class="preview-subject">${e.subject}</span><span class="preview-class">${e.className}</span></div>`;
                        }
                        html += `<td>${cellContent}</td>`;
                    }
                    html += `</tr>`;
                }
            });
            html += '</tbody></table>';
            document.getElementById('printPreviewContent').innerHTML = html;
            document.getElementById('printPreviewModal').classList.add('show');
        }

        function exportToFile() {
            const data = { classes, timetableData, blockedSlots: Array.from(blockedSlots), magicRules, magicSubjectKeys, teacherHours: document.getElementById('teacherHours').value, teacherName: document.getElementById('teacherNameInput').value, gradeLevel: document.getElementById('gradeLevelInput').value, schoolYear: document.getElementById('schoolYearInput').value, allSubjects, hiddenSubjects: Array.from(hiddenSubjects) };
            const json = JSON.stringify(data, null, 2); const blob = new Blob([json], { type: "application/json" }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `stundenplan_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast("Datei heruntergeladen!");
        }
        function importFromFile(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    classes = data.classes || []; timetableData = data.timetableData || {}; blockedSlots = new Set(data.blockedSlots || []); magicRules = data.magicRules || []; magicSubjectKeys = data.magicSubjectKeys || ["MAT", "DEU", "ENG"];
                    if(data.teacherHours) document.getElementById('teacherHours').value = data.teacherHours; if(data.teacherName) document.getElementById('teacherNameInput').value = data.teacherName; if(data.gradeLevel) document.getElementById('gradeLevelInput').value = data.gradeLevel; if(data.schoolYear) document.getElementById('schoolYearInput').value = data.schoolYear;
                    if(data.allSubjects) allSubjects = data.allSubjects; if(data.hiddenSubjects) hiddenSubjects = new Set(data.hiddenSubjects);
                    ensureZUP(); 
                    renderClasses(); if (classes.length > 0) selectClass(0); else selectedClassIndex = -1; renderTimetable(); updateLiveStats(); showToast("Plan importiert!");
                } catch (err) { showToast("Fehler beim Import: " + err.message, true); } input.value = '';
            }; reader.readAsText(file);
        }

        // #######################################################
        // ### ABSCHNITT: UI & LAYOUT LOGIK                    ###
        // #######################################################
        function toggleStatsPosition() {
            const stats = document.getElementById('statsFooter');
            const content = document.getElementById('liveStatsContent');
            const targetHours = document.getElementById('targetHoursSection');
            const aside = document.querySelector('aside');
            const arrow = document.getElementById('statsPositionArrow');

            if (stats.dataset.position === 'top') {
                stats.dataset.position = 'bottom';
                stats.className = "p-3 bg-slate-50 border-t border-gray-200 mt-auto"; 
                aside.appendChild(stats);
                content.classList.remove('max-h-[60vh]');
                content.classList.add('max-h-32');
                if(arrow) { arrow.classList.remove('rotate-180'); arrow.classList.add('fa-chevron-up'); arrow.classList.remove('fa-chevron-down'); }
            } else {
                stats.dataset.position = 'top';
                stats.className = "bg-blue-50 border border-blue-100 rounded-lg p-2 mb-4 shrink-0 transition-all duration-300 shadow-sm";
                targetHours.insertAdjacentElement('afterend', stats);
                content.classList.remove('max-h-32');
                content.classList.add('max-h-[60vh]');
                if(arrow) { arrow.classList.add('rotate-180'); arrow.classList.remove('fa-chevron-up'); arrow.classList.add('fa-chevron-down'); }
            }
        }

        // --- TOUR (Anleitung) ---
        let currentTourStep = 0;
        const tourSteps = [
            { targetId: null, title: "Willkommen beim Sop√§dStundenplaner!", text: "Dieses Tool beherrscht zwei Dinge: 1. Das manuelle Erstellen von Stundenpl√§nen. 2. Die automatische Erstellung und Kombination von mehreren Stundenpl√§nen." },
            { targetId: "personalDataSection", title: "1. Wer bist du?", text: "Trage oben deinen Namen, Jahrgang und das Schuljahr ein. Das erscheint sp√§ter auf dem Ausdruck." },
            { targetId: "classInputSection", title: "2. Klassen anlegen", text: "Erstelle hier nacheinander alle deine Klassen (z.B. 6a, 6b...) und best√§tige jeweils mit Enter." },
            { targetId: "subjectSection", title: "3. Manuelles Ausf√ºllen", text: "W√§hle oben eine Klasse aus. Tippe dann hier links ein Fach an. Der Planer beginnt bei Mo-1.Std und springt automatisch weiter. Fertig? Dann w√§hle die n√§chste Klasse." },
            { targetId: "mainTimetable", title: "4. Power-User Features", text: "Pro-Tipp: Nutze die Pfeiltasten zur Navigation. Dr√ºcke A-Z, um F√§cher sofort einzuf√ºgen (z.B. 'M' f√ºr Mathe). Dr√ºcke Enter, um zum n√§chsten Feld zu springen." },
            { targetId: "mainTimetable", title: "5. Strategie-Wahl", text: "Jetzt entscheidest du: Entweder klickst du deine F√§cher im Plan an, um sie manuell zu belegen (sie werden farbig). Oder... jetzt kommt die Magie: Du l√§sst Auto-Verteilen." },
            { targetId: "targetHoursSection", title: "6. Vorbereitung Auto", text: "Bevor du 'Auto' dr√ºckst: 1. Lege dein Stunden-Ziel fest (gelbes Feld). 2. Nutze 'Sperren' (‚õî), um Zeiten zu blockieren, an denen du nicht kannst." },
            { targetId: "btnMagicSettings", title: "7. F√§cher-Pool", text: "Hinter dem Zahnrad verbirgt sich die F√§cherauswahl. Hier kannst du neue F√§cher anlegen oder nicht ben√∂tigte F√§cher ausblenden." },
            { targetId: "btnRules", title: "8. Regeln", text: "Im Button daneben (Regeln) kannst du Zw√§nge definieren: Z.B. 'Ich muss in der 6e unbedingt 2x Mathe machen'." },
            { targetId: "mainTimetable", title: "9. Pinnen", text: "Auch im Plan selbst kannst du steuern: Klicke ein Fach an, um es zu 'Pinnen' (Gr√ºner Rahmen). Diese Stunde bleibt dann garantiert erhalten." },
            { targetId: "autoButtonSection", title: "10. Auto-Start", text: "Klicke auf 'Auto'. Dein pers√∂nlicher Plan wird nun nach deinen W√ºnschen und Regeln optimal berechnet." },
            { targetId: "statsFooter", title: "11. Verteilung", text: "Pr√ºfe unter 'Verteilung', wie fair die Stunden gewichtet sind. Manuelle √Ñnderungen aktualisieren diese Anzeige sofort." },
            { targetId: "demoDataBtn", title: "12. Demo-Modus", text: "Noch unsicher? Klicke auf 'Demo', um den Plan einmal komplett mit Testdaten zu f√ºllen." },
            { targetId: "toolbarActions", title: "13. Toolbar & Hilfe", text: "Hier oben findest du Speichern, Drucken und die Hilfe (?)." }
        ];

        function startTour() { currentTourStep = 0; document.getElementById('tourOverlay').classList.add('active'); showTourStep(); }
        function endTour() { document.getElementById('tourOverlay').classList.remove('active'); const dontShow = document.getElementById('tourDontShowAgain').checked; if(dontShow) localStorage.setItem('stundenplan_tour_seen', 'true'); }
        function nextTourStep() { currentTourStep++; if(currentTourStep >= tourSteps.length) { endTour(); } else { showTourStep(); } }
        function showTourStep() {
            const step = tourSteps[currentTourStep];
            const tooltip = document.getElementById('tourTooltip');
            const spotlight = document.getElementById('tourSpotlight');
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourText').textContent = step.text;
            tooltip.classList.remove('visible'); 
            if (step.targetId) {
                const target = document.getElementById(step.targetId);
                const rect = target.getBoundingClientRect();
                spotlight.style.width = (rect.width + 10) + 'px'; spotlight.style.height = (rect.height + 10) + 'px'; spotlight.style.top = (rect.top - 5) + 'px'; spotlight.style.left = (rect.left - 5) + 'px'; spotlight.style.opacity = '1';
                const tooltipWidth = 340; const padding = 10;
                let left = rect.right + 20; let top = rect.top;
                if (left + tooltipWidth > window.innerWidth) { left = rect.left - tooltipWidth - 20; }
                if (left < padding) { left = rect.left + (rect.width / 2) - (tooltipWidth / 2); top = rect.bottom + 20; }
                if (top + 200 > window.innerHeight) { top = Math.max(padding, window.innerHeight - 250); }
                left = Math.max(padding, Math.min(left, window.innerWidth - tooltipWidth - padding));
                tooltip.style.top = top + 'px'; tooltip.style.left = left + 'px';
            } else {
                spotlight.style.width = '0px'; spotlight.style.height = '0px'; spotlight.style.opacity = '0'; spotlight.style.top = '50%'; spotlight.style.left = '50%';
                tooltip.style.top = '50%'; tooltip.style.left = '50%'; tooltip.style.transform = 'translate(-50%, -50%)';
            }
            if(step.targetId) tooltip.style.transform = 'none';
            setTimeout(() => tooltip.classList.add('visible'), 50);
        }

        // #######################################################
        // ### ABSCHNITT: SCAN & BILD VERARBEITUNG             ###
        // #######################################################
        function handleScanUpload(input) {
            const file = input.files[0]; if (!file) return;
            
            // PDF Handling
            if (file.type === 'application/pdf') {
                showToast("Lade PDF... (kann kurz dauern)", false);
                const fileReader = new FileReader();
                fileReader.onload = function(event) {
                    try {
                        const typedarray = new Uint8Array(event.target.result);
                        
                        // Check if lib exists
                        if (typeof pdfjsLib === 'undefined') {
                            showToast("PDF-Bibliothek nicht geladen!", true);
                            return;
                        }

                        const loadingTask = pdfjsLib.getDocument({data: typedarray});
                        
                        loadingTask.promise.then(function(pdf) {
                            // Fetch the first page
                            pdf.getPage(1).then(function(page) {
                                const scale = 2.0; 
                                const viewport = page.getViewport({scale: scale});
                                
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                const renderContext = {
                                    canvasContext: context,
                                    viewport: viewport
                                };
                                const renderTask = page.render(renderContext);
                                renderTask.promise.then(function() {
                                    const imgUrl = canvas.toDataURL(); // Default to PNG
                                    loadScanImage(imgUrl);
                                    showToast("PDF erfolgreich geladen!", false);
                                }).catch(function(err) {
                                    console.error(err);
                                    showToast("Fehler beim Rendern der PDF", true);
                                });
                            });
                        }, function (reason) {
                            console.error(reason);
                            showToast("Fehler beim √ñffnen der PDF", true);
                        });
                    } catch(e) {
                        console.error(e);
                        showToast("Kritischer Fehler beim PDF Import", true);
                    }
                };
                fileReader.readAsArrayBuffer(file);
            } else if (file.type.startsWith('image/')) {
                // Standard Image
                const reader = new FileReader();
                reader.onload = function(e) {
                    loadScanImage(e.target.result);
                };
                reader.readAsDataURL(file);
            } else {
                 showToast("Dateiformat nicht unterst√ºtzt!", true);
            }
            input.value = '';
        }
        
        function loadScanImage(imgUrl) {
            scanImage = imgUrl;
            
            // Reset Settings for new image
            scanSettings = { zoom: 100, x: 0, y: 0, rotation: 0 };
            document.getElementById('scanZoomSlider').value = 100;
            document.getElementById('scanXSlider').value = 0;
            document.getElementById('scanYSlider').value = 0;
            document.getElementById('scanRotateSlider').value = 0;
            
            document.body.classList.add('scan-active');
            document.getElementById('scanControls').classList.add('show');
            document.getElementById('reopenScanBtn').classList.add('hidden');
            
            // NEU: Styles f√ºr bessere Sichtbarkeit und Scrolling injizieren
            if (!document.getElementById('scan-dynamic-styles')) {
                const style = document.createElement('style');
                style.id = 'scan-dynamic-styles';
                style.innerHTML = `
                    /* Damit das Bild mitscrollt */
                    #timetableBody { position: relative !important; }
                    
                    /* Dickere schwarze Linien zur Orientierung im Scan-Modus */
                    body.scan-active .print-lesson, 
                    body.scan-active .print-break { border-bottom: 1px solid #000 !important; }
                    body.scan-active .print-lesson > div, 
                    body.scan-active .time-col { border-right: 1px solid #000 !important; }
                    body.scan-active .time-col { border-bottom: 1px solid #000 !important; }
                `;
                document.head.appendChild(style);
            }

            renderTimetable(); 
            enableScanAdjustmentMode();
            showToast("Bild geladen. Passe es nun an!", false);
        }

        function enableScanAdjustmentMode() {
            isScanAdjustmentMode = true;
            document.body.classList.add('scan-adjust-mode');
            document.getElementById('timetableBody').style.overflow = 'hidden'; 
            setupScanDragListeners();
        }

        function disableScanAdjustmentMode() {
            isScanAdjustmentMode = false;
            document.body.classList.remove('scan-adjust-mode');
            document.getElementById('timetableBody').style.overflow = 'auto'; 
        }

        function setupScanDragListeners() { /* Bereits im Init */ }

        function getTouchDistance(e) { return Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); }

        function handleDragStart(e) {
            if (!isScanAdjustmentMode) return;
            if (e.touches && e.touches.length === 2) {
                isPinching = true; isDraggingScan = false; pinchStartDist = getTouchDistance(e); pinchStartZoom = parseInt(scanSettings.zoom); e.preventDefault(); return;
            }
            isDraggingScan = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragStartX = clientX; dragStartY = clientY;
            initialScanX = parseInt(scanSettings.x) || 0; initialScanY = parseInt(scanSettings.y) || 0;
            if (e.touches) e.preventDefault(); 
        }

        function handleDragMove(e) {
            if (!isScanAdjustmentMode) return;
            if (isPinching && e.touches && e.touches.length === 2) {
                const newDist = getTouchDistance(e);
                const scale = newDist / pinchStartDist;
                let newZoom = pinchStartZoom * scale;
                newZoom = Math.min(Math.max(newZoom, 20), 500);
                updateScanZoom(newZoom); document.getElementById('scanZoomSlider').value = newZoom;
                e.preventDefault(); return;
            }
            if (!isDraggingScan) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const dx = clientX - dragStartX; const dy = clientY - dragStartY;
            let newX = initialScanX + dx; let newY = initialScanY + dy;
            updateScanX(newX); updateScanY(newY);
            document.getElementById('scanXSlider').value = newX; document.getElementById('scanYSlider').value = newY;
            e.preventDefault(); 
        }

        function handleDragEnd(e) {
            isDraggingScan = false;
            if (e.touches && e.touches.length < 2) { isPinching = false; }
        }

        function updateScanOpacity(val) {
            const cells = document.querySelectorAll('.print-lesson, .print-break, .time-col');
            const opacity = val / 100;
            cells.forEach(c => c.style.setProperty('background-color', `rgba(255,255,255,${opacity})`, 'important'));
        }

        function updateScanZoom(val) { scanSettings.zoom = val; updateScanTransform(); }
        function updateScanX(val) { scanSettings.x = parseInt(val); updateScanTransform(); }
        function updateScanY(val) { scanSettings.y = parseInt(val); updateScanTransform(); }
        function updateScanRotation(val) { scanSettings.rotation = parseInt(val); updateScanTransform(); }
        
        function updateScanTransform(imgEl = null) {
            const img = imgEl || document.getElementById('scanImageLayer');
            if (!img) return;
            img.style.transform = `translate(-50%, -50%) translate(${scanSettings.x}px, ${scanSettings.y}px) rotate(${scanSettings.rotation}deg) scale(${scanSettings.zoom / 100})`;
        }
        
        function finishScanAdjustment() {
             document.getElementById('scanControls').classList.remove('show');
             document.getElementById('reopenScanBtn').classList.remove('hidden');
             disableScanAdjustmentMode();
             showToast("Fertig! Tippe jetzt F√§cher ein.");
        }
        
        function reopenScanAdjustment() {
             document.getElementById('scanControls').classList.add('show');
             document.getElementById('reopenScanBtn').classList.add('hidden');
             enableScanAdjustmentMode();
        }
        
        function removeScan() {
             document.body.classList.remove('scan-active');
             document.getElementById('scanControls').classList.remove('show');
             document.getElementById('reopenScanBtn').classList.add('hidden');
             
             // Aufr√§umen: Styles entfernen
             const style = document.getElementById('scan-dynamic-styles');
             if(style) style.remove();

             disableScanAdjustmentMode(); scanImage = null; renderTimetable(); 
             const cells = document.querySelectorAll('.print-lesson, .print-break, .time-col');
             cells.forEach(c => c.style.backgroundColor = '');
             showToast("Hintergrundbild entfernt");
        }

        // #######################################################
        // ### ABSCHNITT: REGELN & EINSTELLUNGEN               ###
        // #######################################################
        function updateRulesFromPin(className, subject) {
            let pinCount = 0; for (const key in timetableData) { timetableData[key].forEach(e => { if (e.isManual && e.className === className && e.subject === subject) pinCount++; }); }
            // Pins werden nur als Min-Regeln interpretiert (Standard 'min')
            let ruleIdx = magicRules.findIndex(r => r.className === className && r.subject === subject && (r.type === 'min' || !r.type));
            if (pinCount > 0) { 
                if (ruleIdx === -1) { 
                    magicRules.push({ className: className, subject: subject, hours: pinCount, type: 'min' }); 
                    showToast(`Regel erstellt: ${className} ${subject} Min: ${pinCount}`); 
                } else { 
                    if (magicRules[ruleIdx].hours !== pinCount) { 
                        magicRules[ruleIdx].hours = pinCount; 
                        showToast(`Regel angepasst: ${className} ${subject} Min: ${pinCount}`); 
                    } 
                } 
            } else { 
                if (ruleIdx !== -1) { 
                    magicRules.splice(ruleIdx, 1); 
                    showToast(`Regel gel√∂scht: ${className} ${subject}`); 
                } 
            }
            if(document.getElementById('rulesModal').classList.contains('show')) renderRuleList();
        }

        function openRulesModal() { disableBlockingMode(); updateHeaderColor('neutral'); if (classes.length === 0) { showToast("Bitte erst Klassen erstellen!", true); return; } updateRuleFormOptions(); renderRuleList(); document.getElementById('rulesModal').classList.add('show'); }
        function closeRulesModal() { document.getElementById('rulesModal').classList.remove('show'); }
        
        function updateRuleTypeUI() {
            const type = document.getElementById('ruleTypeSelect').value;
            const subjectContainer = document.getElementById('ruleSubjectContainer');
            if(type === 'max') {
                subjectContainer.style.opacity = '0.3';
                subjectContainer.style.pointerEvents = 'none';
                document.getElementById('ruleSubjectSelect').innerHTML = '<option value="ALLE">ALLE</option>';
            } else {
                subjectContainer.style.opacity = '1';
                subjectContainer.style.pointerEvents = 'auto';
                updateRuleSubjectOptions();
            }
        }

        function updateRuleFormOptions() { 
            const classSelect = document.getElementById('ruleClassSelect'); 
            classSelect.innerHTML = classes.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); 
            const hasSpecialCourses = Object.values(timetableData).some(entries => entries.some(e => ['WPF', 'F√ñA'].includes(e.subject)));
            if (hasSpecialCourses) { classSelect.innerHTML += '<option value="Kurs">Kurs</option>'; }
            if(selectedClassIndex > -1 && classes[selectedClassIndex]) { classSelect.value = classes[selectedClassIndex].name; } 
            
            // Standardm√§√üig Min w√§hlen
            document.getElementById('ruleTypeSelect').value = 'min';
            updateRuleTypeUI();
            
            classSelect.onchange = updateRuleSubjectOptions; 
        }
        function updateRuleSubjectOptions() {
            if(document.getElementById('ruleTypeSelect').value === 'max') return; // Bei Max brauchen wir keine F√§cher
            
            const classSelect = document.getElementById('ruleClassSelect'); 
            const subjectSelect = document.getElementById('ruleSubjectSelect'); 
            const className = classSelect.value;
            if(!className) { subjectSelect.innerHTML = ''; return; }
            if (className === 'Kurs') {
                const courseSubjects = new Set();
                Object.values(timetableData).forEach(entries => { entries.forEach(e => { if (['WPF', 'F√ñA'].includes(e.subject)) { courseSubjects.add(e.subject); } }); });
                const sorted = Array.from(courseSubjects).sort();
                if(sorted.length === 0) { subjectSelect.innerHTML = '<option value="">(Leer)</option>'; } else { subjectSelect.innerHTML = sorted.map(s => `<option value="${s}">${s}</option>`).join(''); }
                return;
            }
            const usedSubjects = new Set(); for(const key in timetableData) { timetableData[key].forEach(entry => { if(entry.className === className && entry.subject !== '---') { usedSubjects.add(entry.subject); } }); }
            const sorted = Array.from(usedSubjects).sort();
            if(sorted.length === 0) { subjectSelect.innerHTML = '<option value="">(Keine F√§cher im Plan)</option>'; } else { subjectSelect.innerHTML = sorted.map(s => `<option value="${s}">${s}</option>`).join(''); }
        }
        function addRule() { 
            const c = document.getElementById('ruleClassSelect').value; 
            const type = document.getElementById('ruleTypeSelect').value;
            const s = type === 'max' ? 'ALLE' : document.getElementById('ruleSubjectSelect').value; 
            const h = parseInt(document.getElementById('ruleCountInput').value); 
            
            if (!c || !s || !h) return; 
            
            const existingIdx = magicRules.findIndex(r => r.className === c && r.subject === s && r.type === type); 
            if (existingIdx > -1) magicRules[existingIdx].hours = h; 
            else magicRules.push({ className: c, subject: s, hours: h, type: type }); 
            renderRuleList(); 
        }
        function deleteRule(index) { magicRules.splice(index, 1); renderRuleList(); }
        
        function renderRuleList() { 
            const list = document.getElementById('ruleList'); list.innerHTML = ''; 
            if (magicRules.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 italic text-sm py-4">Keine Regeln definiert.</div>'; return; } 
            magicRules.forEach((r, idx) => { 
                const div = document.createElement('div'); 
                div.className = "flex justify-between items-center bg-white p-2 rounded border border-gray-200 shadow-sm"; 
                
                let typeBadge = '';
                if(r.type === 'max') {
                    typeBadge = '<span class="text-xs font-bold text-red-600 bg-red-100 px-1 rounded mr-1">MAX</span>';
                } else if(r.type === 'max_subject') {
                    typeBadge = '<span class="text-xs font-bold text-purple-600 bg-purple-100 px-1 rounded mr-1">FACH-MAX</span>';
                } else {
                    typeBadge = '<span class="text-xs font-bold text-green-600 bg-green-100 px-1 rounded mr-1">MIN</span>';
                }
                
                div.innerHTML = `<div class="flex items-center gap-2 text-sm">${typeBadge}<span class="font-bold text-gray-800 bg-gray-100 px-2 rounded">${r.className}</span><span class="text-gray-600">${r.subject}</span><span class="text-blue-600 font-bold ml-2">${r.hours} Std.</span></div><button onclick="deleteRule(${idx})" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-trash"></i></button>`; 
                list.appendChild(div); 
            }); 
        }

        function handleNewSubjectEnter(e) { if(e.key === 'Enter') addNewSubject(); }
        function addNewSubject() { const input = document.getElementById('newSubjectInput'); const val = input.value.trim().toUpperCase(); if(!val) return; if(allSubjects.includes(val)) { showToast("Fach existiert bereits!", true); return; } allSubjects.push(val); input.value = ''; renderMagicSettingsList(); renderSubjects(); showToast("Fach hinzugef√ºgt: " + val); }
        function filterMagicSettings(query) { renderMagicSettingsList(query); }
        function deleteCustomSubject(subj) { if(confirm(`Fach "${subj}" wirklich l√∂schen?`)) { allSubjects = allSubjects.filter(s => s !== subj); hiddenSubjects.delete(subj); magicSubjectKeys = magicSubjectKeys.filter(s => s !== subj); const currentFilter = document.getElementById('newSubjectInput').value; renderMagicSettingsList(currentFilter); renderSubjects(); } }
        function toggleSubjectVisibility(subj) { if(hiddenSubjects.has(subj)) { hiddenSubjects.delete(subj); } else { hiddenSubjects.add(subj); } const currentFilter = document.getElementById('newSubjectInput').value; renderMagicSettingsList(currentFilter); renderSubjects(); }
        function deselectAllMagic() { magicSubjectKeys = []; const currentFilter = document.getElementById('newSubjectInput').value; renderMagicSettingsList(currentFilter); showToast("Alle Auto-Haken entfernt."); }
        function showAllSubjects() { hiddenSubjects.clear(); const currentFilter = document.getElementById('newSubjectInput').value; renderMagicSettingsList(currentFilter); renderSubjects(); showToast("Alle F√§cher sichtbar."); }
        function hideSubject(e, subj) { e.preventDefault(); if(subj === '---') return; hiddenSubjects.add(subj); renderSubjects(); showToast(`${subj} ausgeblendet (wiederherstellen √ºber Zahnrad)`); }
        function openMagicSettings() { disableBlockingMode(); updateHeaderColor('neutral'); document.getElementById('magicSettingsModal').classList.add('show'); document.getElementById('newSubjectInput').value = ''; document.getElementById('newSubjectInput').focus(); renderMagicSettingsList(); }
        function isSubjectVisible(subj) { return !hiddenSubjects.has(subj); }
        function renderMagicSettingsList(filterText = '') {
            const list = document.getElementById('magicSettingsList'); list.innerHTML = ''; const upperFilter = filterText.toUpperCase().trim();
            allSubjects.filter(s => s !== '---').forEach(subj => { 
                if(upperFilter && !subj.includes(upperFilter)) return;
                const isChecked = magicSubjectKeys.includes(subj); const isVisible = isSubjectVisible(subj);
                let rowClass = "flex justify-between items-center p-2 rounded hover:bg-gray-50 border-b border-gray-100 last:border-0"; if (!isVisible) rowClass += " bg-gray-100 opacity-75"; 
                const div = document.createElement('div'); div.className = rowClass;
                const checkStyle = isVisible ? '' : 'opacity-20 pointer-events-none';
                const magicCheck = `<input type="checkbox" onchange="toggleMagicKey('${subj}')" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-amber-600 rounded focus:ring-amber-500 border-gray-300 ${checkStyle}">`;
                const visIcon = isVisible ? 'fa-eye text-gray-600' : 'fa-eye-slash text-gray-400';
                const visBtn = `<button onclick="toggleSubjectVisibility('${subj}')" class="w-6 text-center hover:bg-gray-200 rounded p-0.5"><i class="fas ${visIcon}"></i></button>`;
                const deleteBtn = `<button onclick="deleteCustomSubject('${subj}')" class="text-gray-300 hover:text-red-500 ml-2 w-4"><i class="fas fa-trash-alt text-xs"></i></button>`;
                div.innerHTML = `<span class="text-sm font-medium ${!isVisible ? 'text-gray-500 line-through' : 'text-gray-700'}">${subj}</span><div class="flex items-center gap-4">${visBtn}${magicCheck}${deleteBtn}</div>`; list.appendChild(div); 
            }); 
            if(list.children.length === 0 && filterText) { list.innerHTML = `<div class="text-center text-gray-400 text-xs py-4">"${filterText}" nicht gefunden.<br>Dr√ºcke <b>+</b> zum Erstellen.</div>`; }
        }
        function toggleMagicKey(subj) { if(magicSubjectKeys.includes(subj)) { magicSubjectKeys = magicSubjectKeys.filter(s => s !== subj); } else { magicSubjectKeys.push(subj); } }
        function saveMagicSettings() { closeMagicSettings(); showToast("Einstellungen √ºbernommen."); }
        function closeMagicSettings() { document.getElementById('magicSettingsModal').classList.remove('show'); }
        
        // #######################################################
        // ### ABSCHNITT: STATISTIK & BERICHT                  ###
        // #######################################################
        function generateStatsHTML(targetHours) {
            let currentAssigned = 0; let classCounts = {}; let classSubjectStats = {}; let globalCounts = {};
            classes.forEach(c => { classCounts[c.name] = 0; classSubjectStats[c.name] = {}; });
            for (const key in timetableData) {
                timetableData[key].forEach(entry => {
                    if (entry.isMagicSelected || entry.isManual) {
                        currentAssigned++;
                        if (GLOBAL_SUBJECTS.includes(entry.subject)) { if (!globalCounts[entry.subject]) globalCounts[entry.subject] = 0; globalCounts[entry.subject]++; } 
                        else if (classCounts[entry.className] !== undefined) { classCounts[entry.className]++; if (!classSubjectStats[entry.className][entry.subject]) classSubjectStats[entry.className][entry.subject] = 0; classSubjectStats[entry.className][entry.subject]++; }
                    }
                });
            }
            let html = '';
            if (Object.keys(globalCounts).length > 0) { html += `<div class="mb-3 pb-2 border-b border-gray-200"><h4 class="text-[10px] font-bold text-amber-700 uppercase tracking-wide mb-1">Kurse</h4><div class="flex flex-wrap gap-1">`; for (const subj in globalCounts) { html += `<span class="px-1.5 py-0.5 rounded bg-amber-100 text-amber-800 border border-amber-200 text-[10px] font-bold flex items-center">${globalCounts[subj]}x ${subj} <i class="fas fa-users ml-1 opacity-70"></i></span>`; } html += `</div></div>`; }
            html += `<ul class="space-y-2">`;
            let hasClassData = false;
            classes.forEach(c => {
                const count = classCounts[c.name];
                if (count > 0) {
                    hasClassData = true; const subjects = classSubjectStats[c.name]; let subjectParts = [];
                    for(const subj in subjects) { subjectParts.push(`<span class="bg-gray-100 px-1 py-0.5 rounded text-gray-700 border border-gray-200 text-[10px]">${subjects[subj]}x ${subj}</span>`); }
                    html += `<li class="border-b border-gray-100 pb-1 last:border-0 last:pb-0"><div class="flex justify-between items-center mb-0.5"><div class="font-bold text-gray-800 text-xs flex items-center"><span class="w-2 h-2 rounded-full mr-1.5 ${c.colorClass.split(' ')[0]}"></span>${c.name}</div><span class="font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded text-[10px]">${count} Std.</span></div><div class="flex flex-wrap gap-1 ml-4">${subjectParts.join('')}</div></li>`;
                }
            });
            if (!hasClassData && Object.keys(globalCounts).length === 0) html += '<li class="text-gray-400 italic text-center py-2 text-xs">Keine Stunden zugewiesen.</li>';
            html += '</ul>';
            return { html, currentAssigned };
        }

        function updateLiveStats() {
            const targetHours = parseInt(document.getElementById('teacherHours').value) || 27;
            const stats = generateStatsHTML(targetHours);
            document.getElementById('totalAssignedBadge').textContent = `${stats.currentAssigned}/${targetHours}`;
            document.getElementById('liveStatsContent').innerHTML = stats.html;
            lastResultData = { counts: {}, stats: {}, total: stats.currentAssigned, target: targetHours, warning: '' };
        }

        function showResult(counts, statsObj, total, target, warning = '') {
             updateLiveStats();
             let html = warning;
             html += `<div class="bg-blue-50 border border-blue-100 p-3 rounded mb-4"><div class="text-sm text-blue-800">Gesamtziel: <span class="font-bold">${target} Std.</span></div><div class="text-lg font-bold text-blue-900">Zugewiesen: ${total} Std.</div></div>`;
             html += document.getElementById('liveStatsContent').innerHTML;
             document.getElementById('resultContent').innerHTML = html;
             document.getElementById('resultModal').classList.add('show');
        }

        function closeResult() { 
            document.getElementById('resultModal').classList.remove('show');
            const stats = document.getElementById('statsFooter');
            if(stats.dataset.position !== 'top') { toggleStatsPosition(); }
        }
        
        function reopenResult() { 
            disableBlockingMode();
            updateHeaderColor('neutral');
            showResult(null, null, document.getElementById('totalAssignedBadge').textContent.split('/')[0], document.getElementById('teacherHours').value); 
        }
        
        function toggleBlockingMode() { 
            isBlockingMode = !isBlockingMode; 
            const btn = document.getElementById('blockToggleBtn'); 
            if (isBlockingMode) { 
                updateHeaderColor('neutral'); 
                btn.classList.remove('bg-white', 'text-red-500'); btn.classList.add('bg-red-500', 'text-white'); btn.innerHTML = `<i class="fas fa-check"></i>`; document.body.classList.add('blocking-active'); 
            } else { 
                btn.classList.remove('bg-red-500', 'text-white'); btn.classList.add('bg-white', 'text-red-500'); btn.innerHTML = `<i class="fas fa-ban"></i>`; document.body.classList.remove('blocking-active'); 
            } 
        }
        
        function disableBlockingMode() { if (isBlockingMode) { toggleBlockingMode(); } }
        function clearMagicSelection() { for (const key in timetableData) { timetableData[key].forEach(entry => { if (!entry.isManual) entry.isMagicSelected = false; }); } renderTimetable(); updateLiveStats(); }
        
        // #######################################################
        // ### ABSCHNITT: AUTO VERTEILUNG (ALGORITHMUS)        ###
        // #######################################################
        function runMagicAlgorithm() {
            disableBlockingMode(); clearMagicSelection();
            const targetHours = parseInt(document.getElementById('teacherHours').value) || 27; let currentAssigned = 0; const isMainSubject = (subj) => magicSubjectKeys.includes(subj); let teacherGrid = Array(5).fill().map(() => Array(10).fill(false)); let potentialSlotsCount = 0; let blockedMissesCount = 0;
            
            // NEU: Z√§hler f√ºr F√§cher pro Klasse
            let classSubjectCounts = {}; 
            classes.forEach(c => { classSubjectCounts[c.name] = {}; });
            
            const addSubjectCount = (cls, subj) => {
                if(!classSubjectCounts[cls]) classSubjectCounts[cls] = {};
                if(!classSubjectCounts[cls][subj]) classSubjectCounts[cls][subj] = 0;
                classSubjectCounts[cls][subj]++;
            };

            // Vorbereitung: Bestehende manuelle Eintr√§ge z√§hlen & Grid f√ºllen
            for (const key in timetableData) {
                 const [dStr, pStr] = key.split('-'); const day = parseInt(dStr.replace('d', '')); const period = parseInt(pStr.replace('p', ''));
                timetableData[key].forEach(entry => {
                    if (entry.isManual) { 
                        if (!teacherGrid[day][period]) { teacherGrid[day][period] = true; currentAssigned++; }
                        addSubjectCount(entry.className, entry.subject);
                    }
                    const isRuleSubject = magicRules.some(r => r.className === entry.className && r.subject === entry.subject && (r.type === 'min' || !r.type));
                    if (isMainSubject(entry.subject) || isRuleSubject) { potentialSlotsCount++; if (blockedSlots.has(key)) blockedMissesCount++; }
                });
            }

            // SCHRITT 1: Min-Regeln erf√ºllen (Muss-Stunden)
            magicRules.forEach(rule => {
                if(rule.type === 'max' || rule.type === 'max_subject') return; // Max-Regeln hier ignorieren
                
                let ruleAlreadyMet = 0; for (const key in timetableData) { timetableData[key].forEach(entry => { if (entry.isManual && entry.className === rule.className && entry.subject === rule.subject) ruleAlreadyMet++; }); }
                let needed = rule.hours - ruleAlreadyMet; if (needed <= 0) return;
                let ruleAssigned = 0; let ruleCandidates = [];
                for (const key in timetableData) {
                    if (blockedSlots.has(key)) continue; const [dStr, pStr] = key.split('-'); const day = parseInt(dStr.replace('d', '')); const period = parseInt(pStr.replace('p', ''));
                    if (teacherGrid[day][period]) continue;
                    timetableData[key].forEach((entry, index) => { if (entry.className === rule.className && entry.subject === rule.subject && !entry.isManual && !entry.isMagicSelected) { ruleCandidates.push({ key, day, period, entryIndex: index }); } });
                }
                ruleCandidates.sort((a,b) => (teacherGrid[a.day][a.period-1] ? -1 : 1)); 
                for(let k=0; k<needed; k++) { 
                    if(k < ruleCandidates.length && currentAssigned < targetHours) { 
                        // Pr√ºfen ob Max-Regel verletzt wird
                        const cand = ruleCandidates[k]; 
                        const maxRule = magicRules.find(r => r.type === 'max' && r.className === rule.className);
                        if(maxRule) {
                            let currentClassHours = 0;
                            for(const ck in timetableData) { timetableData[ck].forEach(ce => { if((ce.isManual || ce.isMagicSelected) && ce.className === rule.className) currentClassHours++; }); }
                            if(currentClassHours >= maxRule.hours) continue; 
                        }
                        // Fach-Max Check (unwahrscheinlich bei Min-Zwang, aber sicherheitshalber)
                        const maxSubjRule = magicRules.find(r => r.type === 'max_subject' && r.className === rule.className && r.subject === rule.subject);
                        if(maxSubjRule) {
                             const curr = classSubjectCounts[rule.className] && classSubjectCounts[rule.className][rule.subject] ? classSubjectCounts[rule.className][rule.subject] : 0;
                             if(curr >= maxSubjRule.hours) continue;
                        }

                        timetableData[cand.key][cand.entryIndex].isMagicSelected = true; 
                        teacherGrid[cand.day][cand.period] = true; 
                        currentAssigned++; 
                        addSubjectCount(cand.className, cand.subject);
                    } 
                }
            });

            // Vorbereitung Counts f√ºr F√ºll-Algorithmus
            let classCounts = {}; classes.forEach(c => { classCounts[c.name] = 0; });
            for (const key in timetableData) { timetableData[key].forEach(entry => { if ((entry.isMagicSelected || entry.isManual) && classCounts[entry.className] !== undefined && !GLOBAL_SUBJECTS.includes(entry.subject)) { classCounts[entry.className]++; } }); }
            
            const maxRules = magicRules.filter(r => r.type === 'max');
            const maxSubjectRules = magicRules.filter(r => r.type === 'max_subject');

            // SCHRITT 2: Restliche Stunden auff√ºllen
            while (currentAssigned < targetHours) {
                let bestMove = null; let bestScore = -999999; let currentMin = 999; let activeClasses = new Set();
                
                for (const key in timetableData) {
                    if (blockedSlots.has(key)) continue; const [dStr, pStr] = key.split('-'); const day = parseInt(dStr.replace('d', '')); const period = parseInt(pStr.replace('p', ''));
                    if (teacherGrid[day][period]) continue;
                    timetableData[key].forEach(e => { if (isMainSubject(e.subject) && !e.isManual && !e.isMagicSelected) { if(!GLOBAL_SUBJECTS.includes(e.subject)) activeClasses.add(e.className); } });
                }
                if (activeClasses.size > 0) { activeClasses.forEach(clsName => { const h = classCounts[clsName] || 0; if (h < currentMin) currentMin = h; }); }
                
                for (const key in timetableData) {
                    if (blockedSlots.has(key)) continue; const [dStr, pStr] = key.split('-'); const day = parseInt(dStr.replace('d', '')); const period = parseInt(pStr.replace('p', ''));
                    if (teacherGrid[day][period]) continue;
                    
                    timetableData[key].forEach((entry, index) => {
                        if (isMainSubject(entry.subject) && !entry.isManual && !entry.isMagicSelected) {
                            // MAX KLASSE CHECK
                            const maxRule = maxRules.find(r => r.className === entry.className);
                            if (maxRule) {
                                const currentClsHrs = classCounts[entry.className] || 0;
                                if (currentClsHrs >= maxRule.hours) return; 
                            }
                            
                            // MAX FACH CHECK
                            const maxSubjRule = maxSubjectRules.find(r => r.className === entry.className && r.subject === entry.subject);
                            if (maxSubjRule) {
                                const currSubjHrs = classSubjectCounts[entry.className] && classSubjectCounts[entry.className][entry.subject] ? classSubjectCounts[entry.className][entry.subject] : 0;
                                if (currSubjHrs >= maxSubjRule.hours) return;
                            }

                            let score = 0;
                            if(GLOBAL_SUBJECTS.includes(entry.subject)) { score += 5000; } else { const currentHours = classCounts[entry.className] || 0; if (currentHours === currentMin) score += 10000; else if (currentHours === currentMin + 1) score += 1000; else score -= 1000; }
                            const prevBusy = teacherGrid[day][period - 1]; const nextBusy = teacherGrid[day][period + 1]; if (prevBusy) score += 50; if (nextBusy) score += 50;
                            score += Math.random() * 10; if (score > bestScore) { bestScore = score; bestMove = { key, day, period, index, className: entry.className, subject: entry.subject }; }
                        }
                    });
                }
                
                if (!bestMove) break;
                timetableData[bestMove.key][bestMove.index].isMagicSelected = true; teacherGrid[bestMove.day][bestMove.period] = true;
                if(!GLOBAL_SUBJECTS.includes(bestMove.subject)) { 
                    classCounts[bestMove.className]++; 
                    addSubjectCount(bestMove.className, bestMove.subject);
                } 
                currentAssigned++;
            }
            
            // SCHRITT 3: Optimierung (Tauschen f√ºr bessere Balance)
            let iterations = 0;
            while(iterations < 500) { 
                let changesInLoop = false; 
                
                // Rebuild counts per iteration
                let currentCounts = {}; 
                let currentSubjCounts = {};
                classes.forEach(c => { currentCounts[c.name] = 0; currentSubjCounts[c.name] = {}; });
                
                for (const key in timetableData) { 
                    timetableData[key].forEach(e => { 
                        if ((e.isMagicSelected || e.isManual) && !GLOBAL_SUBJECTS.includes(e.subject)) {
                            currentCounts[e.className]++;
                            if(!currentSubjCounts[e.className][e.subject]) currentSubjCounts[e.className][e.subject] = 0;
                            currentSubjCounts[e.className][e.subject]++;
                        } 
                    }); 
                }
                
                let minH = 999, maxH = -1; let minClass = null, maxClass = null;
                classes.forEach(c => { let h = currentCounts[c.name] || 0; if(h < minH) { minH = h; minClass = c.name; } if(h > maxH) { maxH = h; maxClass = c.name; } });
                if ((maxH - minH) < 2) break; 
                
                for(const key in timetableData) {
                    if (changesInLoop) break; const [dStr, pStr] = key.split('-'); const day = parseInt(dStr.replace('d', '')); const period = parseInt(pStr.replace('p', ''));
                    let richIndex = -1; let richClassName = null;
                    
                    // Suche einen Kandidaten zum Wegnehmen von einer "reichen" Klasse
                    timetableData[key].forEach((e, idx) => { 
                        if(e.isMagicSelected && !e.isManual && !GLOBAL_SUBJECTS.includes(e.subject) && isMainSubject(e.subject)) { 
                            if (currentCounts[e.className] > minH + 1) { richIndex = idx; richClassName = e.className; } 
                        } 
                    });
                    
                    if(richIndex !== -1) {
                        let poorIndex = -1; let poorClassName = null;
                        // Suche einen Kandidaten zum Geben an eine "arme" Klasse im selben Slot
                        timetableData[key].forEach((e, idx) => { 
                            if(currentCounts[e.className] === minH && isMainSubject(e.subject) && !e.isMagicSelected && !e.isManual) { 
                                // MAX CLASS Check f√ºr arme Klasse
                                const maxRule = maxRules.find(r => r.className === e.className);
                                if (!maxRule || currentCounts[e.className] < maxRule.hours) {
                                    // MAX FACH Check
                                    const maxSubjRule = maxSubjectRules.find(r => r.className === e.className && r.subject === e.subject);
                                    const currSubj = currentSubjCounts[e.className][e.subject] || 0;
                                    
                                    if(!maxSubjRule || currSubj < maxSubjRule.hours) {
                                         poorIndex = idx; poorClassName = e.className; 
                                    }
                                }
                            } 
                        });
                        
                        if(poorIndex !== -1) { timetableData[key][richIndex].isMagicSelected = false; timetableData[key][poorIndex].isMagicSelected = true; changesInLoop = true; }
                    }
                }
                if (!changesInLoop) break; iterations++;
            }
            
            let warning = ""; 
            if (currentAssigned < targetHours) { 
                const missing = targetHours - currentAssigned; 
                warning = `<div class="bg-orange-50 border-l-4 border-orange-400 text-orange-800 p-2 mb-3 text-xs"><p class="font-bold mb-2"><i class="fas fa-info-circle mr-1"></i> Fast geschafft! Es fehlen noch ${missing} Stunden.</p>`;
                if (potentialSlotsCount < targetHours) warning += `<p class="mb-1">Im aktuellen Plan gibt es leider nicht gen√ºgend Stunden f√ºr deine gew√§hlten F√§cher (nur ${potentialSlotsCount} verf√ºgbar).</p>`;
                else if (blockedMissesCount > 0) warning += `<p class="mb-1">Einige passende Stunden fallen leider genau in deine Sperrzeiten (‚õî).</p>`;
                else warning += `<p class="mb-1">Es gibt zwar Stunden, aber die finden oft gleichzeitig statt.</p>`;
                warning += `</div>`;
            }
            renderTimetable(); updateLiveStats(); showResult(null, null, currentAssigned, targetHours, warning);
        }

        // #######################################################
        // ### ABSCHNITT: DARSTELLUNG (RENDERING)              ###
        // #######################################################
        function renderClasses() {
            const container = document.getElementById('classList'); container.innerHTML = ''; 
            if (classes.length === 0) { container.innerHTML = '<span class="text-gray-400 text-sm italic self-center pl-2" id="noClassHint">Keine Klassen...</span>'; return; }
            classes.forEach((c, idx) => {
                const btn = document.createElement('div'); const isSelected = selectedClassIndex === idx;
                let styleClass = `cursor-pointer flex items-center px-3 py-1 rounded border shadow-sm transition select-none ${c.colorClass} `;
                if (isSelected) styleClass += `ring-2 ring-offset-1 ring-blue-500 font-bold transform scale-105 opacity-100`; else styleClass += `hover:opacity-100 opacity-60 border-gray-300`;
                btn.className = styleClass; btn.onclick = () => selectClass(idx);
                btn.innerHTML = `<span class="mr-2">${c.name}</span><i class="fas fa-times text-xs opacity-40 hover:opacity-100 hover:text-red-800" onclick="event.stopPropagation(); removeClass(${idx})"></i>`; container.appendChild(btn);
            });
        }
        function updateSelectedClassDisplay() { const el = document.getElementById('selectedClassDisplay'); if (selectedClassIndex > -1) { const c = classes[selectedClassIndex]; el.innerHTML = `Aktiv: <span class="px-2 py-0.5 rounded ${c.colorClass} border text-xs font-bold">${c.name}</span>`; } else { el.innerHTML = ''; } }
        
        function renderSubjects() {
            const grid = document.getElementById('subjectGrid'); grid.innerHTML = '';
            allSubjects.forEach(sub => {
                if(!isSubjectVisible(sub) && sub !== '---') return; 
                const btn = document.createElement('button');
                let fontSize = "text-sm"; if (sub.length > 5) fontSize = "text-xs"; if (sub.length > 10) fontSize = "text-[10px]";
                btn.className = `subject-btn bg-white border border-gray-200 hover:border-blue-500 hover:bg-blue-50 text-gray-700 font-bold py-1 rounded ${fontSize} shadow-sm truncate flex items-center justify-center`;
                if (sub === '---') { btn.innerHTML = '<i class="fas fa-slash text-gray-400 rotate-90" style="font-size: 1.2em;"></i>'; btn.classList.add('border-gray-300', 'bg-gray-50'); } else { btn.textContent = sub; const color = subjectColors[sub]; if(color) { btn.style.borderLeftWidth = '4px'; btn.style.borderLeftColor = color; } }
                btn.onclick = () => insertSubject(sub); btn.oncontextmenu = (e) => hideSubject(e, sub); grid.appendChild(btn);
            });
        }

        function renderCellContent(cellElement, entries) {
            cellElement.innerHTML = '';
            const container = document.createElement('div'); container.className = `cell-wrapper flex flex-col gap-0.5 h-full w-full relative z-10`; 
            if (blockedSlots.has(cellElement.id)) { const overlay = document.createElement('div'); overlay.className = 'blocked-overlay'; cellElement.appendChild(overlay); cellElement.classList.add('blocked-cell'); } else { cellElement.classList.remove('blocked-cell'); }
            if (!entries || entries.length === 0) return;
            const anySelected = entries.some(e => e.isMagicSelected || e.isManual);
            const globalSelected = entries.find(e => (e.isMagicSelected || e.isManual) && GLOBAL_SUBJECTS.includes(e.subject));
            if (globalSelected) {
                 const allClassesString = classes.map(c => c.name).join(', ');
                 const chip = document.createElement('div');
                 let styleClass = 'global-chip';
                 if (globalSelected.subject === 'F√ñA') styleClass += ' special-foea';
                 else if (['WPF', 'SPA', 'TUE'].includes(globalSelected.subject)) styleClass += ' special-wpf';
                 else if (globalSelected.subject === 'ZUP') styleClass += ' special-zup';
                 let subText = allClassesString;
                 if (globalSelected.subject === 'ZUP') subText = 'Teamsitzung';
                 chip.className = `entry-chip ${styleClass}`;
                 chip.style.flex = "1";
                 if(globalSelected.isManual) { chip.innerHTML = `<div class="magic-icon manual"><i class="fas fa-thumbtack"></i></div><span class="chip-subject">${globalSelected.subject}</span><span class="chip-class">${subText}</span>`; } else { chip.innerHTML = `<div class="magic-icon auto"><i class="fas fa-graduation-cap"></i></div><span class="chip-subject">${globalSelected.subject}</span><span class="chip-class">${subText}</span>`; }
                 const idx = entries.indexOf(globalSelected);
                 chip.onclick = (e) => { if (isBlockingMode || isScanAdjustmentMode) return; e.stopPropagation(); setCursor(parseInt(cellElement.id.split('-')[0].substring(1)), parseInt(cellElement.id.split('-')[1].substring(1))); };
                 container.appendChild(chip);
            } else {
                entries.forEach((entry, idx) => {
                    const chip = document.createElement('div'); 
                    let magicClass = ''; let magicIcon = ''; 
                    if (entry.isMagicSelected && !entry.isManual) { magicClass = 'magic-selected'; magicIcon = `<div class="magic-icon auto"><i class="fas fa-graduation-cap"></i></div>`; } else if (entry.isManual) { magicClass = 'manual-selected'; } else if (anySelected) { magicClass = 'dimmed'; }
                    chip.className = `entry-chip ${entry.colorClass} ${magicClass}`;
                    chip.style.flex = "1"; 
                    let subjSize = 'text-[10px]'; if (entries.length === 1) subjSize = 'text-sm lg:text-base'; else if (entries.length > 4) subjSize = 'text-[9px]';
                    const deleteBtn = document.createElement('div'); deleteBtn.className = 'chip-btn delete'; deleteBtn.innerHTML = '<i class="fas fa-times"></i>'; deleteBtn.onclick = (e) => { e.stopPropagation(); removeEntry(cellElement.id, idx); };
                    const pinBtn = document.createElement('div'); pinBtn.className = `chip-btn pin ${entry.isManual ? 'active' : ''}`; pinBtn.innerHTML = '<i class="fas fa-thumbtack"></i>'; pinBtn.onclick = (e) => { e.stopPropagation(); toggleEntryManual(cellElement.id, idx); };
                    let displaySubject = `<span class="${subjSize} font-bold uppercase truncate w-full text-center tracking-tight">${entry.subject}</span>`; if (entry.subject === '---') displaySubject = `<i class="fas fa-slash text-lg opacity-50 rotate-90"></i>`;
                    chip.innerHTML = `${magicIcon}${displaySubject}<span class="text-[8px] leading-tight opacity-75 truncate w-full text-center font-medium">${entry.className}</span>`; 
                    chip.appendChild(deleteBtn); chip.appendChild(pinBtn);
                    chip.onclick = (e) => { if (isBlockingMode || isScanAdjustmentMode) return; e.stopPropagation(); const d = parseInt(cellElement.id.split('-')[0].substring(1)); const p = parseInt(cellElement.id.split('-')[1].substring(1)); setCursor(d, p); };
                    container.appendChild(chip);
                });
            }
            cellElement.appendChild(container);
        }

        function renderTimetable() {
            const body = document.getElementById('timetableBody'); body.innerHTML = '';
            if (scanImage) {
                const img = document.createElement('img');
                img.id = 'scanImageLayer';
                img.src = scanImage;
                updateScanTransform(img);
                body.appendChild(img);
            }
            scheduleStructure.forEach(slot => {
                if (slot.type === 'break') {
                    const row = document.createElement('div'); row.className = "print-break grid grid-cols-[60px_1fr_1fr_1fr_1fr_1fr] bg-gray-200 text-gray-500 border-b border-gray-300"; row.innerHTML = `<div class="py-0.5 text-center text-[10px] flex flex-col justify-center font-mono border-r border-gray-300 bg-gray-300">${slot.start}<br>${slot.end}</div><div class="col-span-5 py-0.5 text-center font-bold tracking-widest text-[10px] uppercase flex items-center justify-center italic">${slot.label}</div>`; body.appendChild(row);
                } else {
                    const row = document.createElement('div'); row.className = "print-lesson grid grid-cols-[60px_1fr_1fr_1fr_1fr_1fr] border-b border-gray-300 min-h-[80px]"; 
                    const timeCell = document.createElement('div'); timeCell.className = "p-1 text-center text-xs flex flex-col justify-center font-mono border-r border-gray-300 bg-gray-50 font-medium"; timeCell.innerHTML = `<span class="text-base font-bold text-gray-700">${slot.id}.</span><span class="text-gray-500 text-[10px] mt-1">${slot.start}<br>${slot.end}</span>`; row.appendChild(timeCell);
                    for (let day = 0; day < 5; day++) {
                        const cellId = `d${day}-p${slot.id}`; const cell = document.createElement('div'); cell.id = cellId; 
                        if (blockedSlots.has(cellId)) cell.className = `p-0.5 border-r border-gray-200 relative hover:bg-gray-50 cursor-pointer transition group blocked-cell`; else cell.className = `p-0.5 border-r border-gray-200 relative hover:bg-gray-50 cursor-pointer transition group`;
                        cell.onclick = () => handleCellClick(day, slot.id); const entries = timetableData[cellId] || []; renderCellContent(cell, entries); row.appendChild(cell);
                    }
                    body.appendChild(row);
                }
            });
        }

        // #######################################################
        // ### ABSCHNITT: INTERAKTIONEN (Klick & Eingabe)      ###
        // #######################################################
        function handleClassEnter(e) { if (e.key === 'Enter') addClass(); }
        function addClass() {
            disableBlockingMode();
            const input = document.getElementById('classInput'); const val = input.value.trim();
            if (val && !classes.some(c => c.name === val)) {
                const colorClass = getColorForClass(val); classes.push({ name: val, colorClass: colorClass });
                if (val.startsWith('5') || val.startsWith('6')) { for (let d = 0; d < 5; d++) { const cellId = `d${d}-p5`; let entries = timetableData[cellId] || []; entries.push({ subject: "MEN", className: val, colorClass: colorClass, isMagicSelected: false, isManual: false }); timetableData[cellId] = entries; } renderTimetable(); } selectClass(classes.length - 1);
            } input.value = ''; input.focus(); renderClasses();
        }
        function removeClass(index) { classes.splice(index, 1); if (selectedClassIndex >= index) selectedClassIndex = Math.max(0, selectedClassIndex - 1); if (classes.length === 0) { selectedClassIndex = -1; updateHeaderColor('neutral'); } renderClasses(); updateSelectedClassDisplay(); renderSubjects(); updateLiveStats(); }
        function selectClass(index) { disableBlockingMode(); selectedClassIndex = index; updateHeaderColor('class', index); renderClasses(); updateSelectedClassDisplay(); renderSubjects(); }
        
        function updateHeaderColor(mode, classIndex) {
            const header = document.getElementById('timetableHeader');
            header.className = "grid grid-cols-[60px_1fr_1fr_1fr_1fr_1fr] text-center font-bold text-sm shadow-md z-10 flex-shrink-0 transition-colors duration-300";
            if (mode === 'class' && classes[classIndex]) { header.className += " " + classes[classIndex].colorClass; } else { header.className += " bg-slate-800 text-white"; }
        }

        function handleCellClick(day, period) {
            if (isScanAdjustmentMode) { showToast("Bitte erst Bild fixieren!", true); return; }
            const cellId = `d${day}-p${period}`; 
            if (isBlockingMode) { if (blockedSlots.has(cellId)) blockedSlots.delete(cellId); else { blockedSlots.add(cellId); if (timetableData[cellId]) timetableData[cellId].forEach(e => { e.isMagicSelected = false; e.isManual = false; }); } renderTimetable(); updateLiveStats(); return; } 
            setCursor(day, period);
        }
        
        function setCursor(day, period) {
            disableBlockingMode();
            const oldId = `d${cursor.day}-p${cursor.period}`; const oldCell = document.getElementById(oldId); if (oldCell) oldCell.classList.remove('active-cell'); 
            day = Math.max(0, Math.min(4, day)); period = Math.max(1, Math.min(8, period));
            cursor = { day, period }; const newId = `d${day}-p${period}`; const newCell = document.getElementById(newId); if (newCell) { newCell.classList.add('active-cell'); newCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } updateCursorVisuals();
        }
        function updateCursorVisuals() { const newId = `d${cursor.day}-p${cursor.period}`; const newCell = document.getElementById(newId); if (newCell) { newCell.classList.add('active-cell'); newCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } }
        
        function removeEntry(cellId, index) { if (timetableData[cellId] && timetableData[cellId][index]) { const entry = timetableData[cellId][index]; updateRulesFromPin(entry.className, entry.subject); timetableData[cellId].splice(index, 1); if (timetableData[cellId].length === 0) delete timetableData[cellId]; renderTimetable(); updateLiveStats(); } }
        function toggleEntryManual(cellId, index) { 
            if (timetableData[cellId] && timetableData[cellId][index]) { 
                const entries = timetableData[cellId]; const entry = entries[index]; 
                const wasManual = entry.isManual; entry.isManual = !wasManual; entry.isMagicSelected = false; 
                updateRulesFromPin(entry.className, entry.subject);
                if (!wasManual) { entries.forEach((e, i) => { if (i !== index && e.isManual) { e.isManual = false; updateRulesFromPin(e.className, e.subject); } }); showToast("Anderes Fach gel√∂st (nur 1 Pin/Feld)"); }
                renderTimetable(); updateLiveStats(); 
            } 
        }

        function insertSubject(subject) {
            if (isBlockingMode) { disableBlockingMode(); return; } 
            if (selectedClassIndex === -1 && classes.length > 0) { showToast("Bitte erst Klasse w√§hlen!", true); return; } 
            const currentClass = selectedClassIndex > -1 ? classes[selectedClassIndex] : { name: '', colorClass: 'bg-gray-200 text-gray-800' }; 
            const cellId = `d${cursor.day}-p${cursor.period}`; let entries = timetableData[cellId] || []; 
            const existingIndex = entries.findIndex(e => e.className === currentClass.name);
            if (existingIndex > -1) {
                const oldSubject = entries[existingIndex].subject; entries[existingIndex].subject = subject;
                if(entries[existingIndex].isManual) { updateRulesFromPin(currentClass.name, oldSubject); updateRulesFromPin(currentClass.name, subject); }
            } else {
                if (entries.length >= 8) { showToast("Max. 8 F√§cher erreicht!", true); return; } 
                entries.push({ subject: subject, className: currentClass.name, colorClass: currentClass.colorClass, isMagicSelected: false, isManual: false }); 
            }
            timetableData[cellId] = entries; renderCellContent(document.getElementById(cellId), entries); 
            if (existingIndex === -1 && entries.length === 1) { advanceCursor(); }
        }

        function advanceCursor() { 
            let nextPeriod = cursor.period + 1; let nextDay = cursor.day; 
            if (nextPeriod > 8) { nextPeriod = 1; nextDay++; if (nextDay > 4) nextDay = 0; } 
            if (nextDay === 2 && nextPeriod === 5) { nextPeriod++; }
            setCursor(nextDay, nextPeriod); 
        }
        function clearActiveCell() { const cellId = `d${cursor.day}-p${cursor.period}`; delete timetableData[cellId]; document.getElementById(cellId).innerHTML = ''; }
        
        function fillTestSchedule() {
            disableBlockingMode();
            if (classes.length === 0) { const demoClasses = ['6a', '6b', '6c', '6d', '6e']; demoClasses.forEach((name, idx) => { classes.push({ name: name, colorClass: classColors[idx % classColors.length] }); }); renderClasses(); selectClass(0); }
            timetableData = {}; blockedSlots = new Set(); lastResultData = null; magicRules = [];
            try {
                let allSlots = []; for(let d=0; d<5; d++) for(let p=1; p<=8; p++) allSlots.push(`d${d}-p${p}`);
                const freeIds = ['d4-p7', 'd4-p8']; let validSlots = allSlots.filter(id => !freeIds.includes(id));
                const mitIds = validSlots.filter(id => id.includes('-p5')); const ksIds = ['d1-p7', 'd1-p8']; const solFixedIds = ['d2-p7', 'd2-p8'];
                const allFixedIds = [...mitIds, ...ksIds, ...solFixedIds];
                let parallelPool = validSlots.filter(id => !allFixedIds.includes(id));
                for (let i = parallelPool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [parallelPool[i], parallelPool[j]] = [parallelPool[j], parallelPool[i]]; }
                const wpfIds = parallelPool.slice(0, 4); const foeaIds = parallelPool.slice(4, 6); const allParallelIds = [...wpfIds, ...foeaIds];
                let entriesCount = 0;
                classes.forEach(cls => {
                    mitIds.forEach(id => addEntry(id, "MEN", cls)); ksIds.forEach(id => addEntry(id, "KS", cls)); solFixedIds.forEach(id => addEntry(id, "SOL", cls));
                    wpfIds.forEach(id => addEntry(id, "WPF", cls)); foeaIds.forEach(id => addEntry(id, "F√ñA", cls));
                    let bucket = []; for(let i=0; i<4; i++) bucket.push("MAT"); for(let i=0; i<4; i++) bucket.push("DEU"); for(let i=0; i<4; i++) bucket.push("ENG"); for(let i=0; i<3; i++) bucket.push("NAT"); for(let i=0; i<2; i++) bucket.push("GGP"); for(let i=0; i<2; i++) bucket.push("SPO"); bucket.push("RAT"); bucket.push("CARE"); bucket.push("IPAD"); bucket.push("SOL");
                    const usedIds = [...allFixedIds, ...allParallelIds]; let mySlots = validSlots.filter(id => !usedIds.includes(id));
                    for (let i = mySlots.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [mySlots[i], mySlots[j]] = [mySlots[j], mySlots[i]]; }
                    bucket.forEach((subj, idx) => { if (idx < mySlots.length) addEntry(mySlots[idx], subj, cls); });
                    entriesCount += bucket.length + 9 + 6;
                });
                ensureZUP(); 
                renderTimetable(); updateLiveStats(); showToast(`Fertig! ${entriesCount} Eintr√§ge.`);
            } catch (e) { showToast("Fehler: " + e.message, true); }
        }
        
        // #######################################################
        // ### ABSCHNITT: TASTATUR-STEUERUNG (Keyboard)        ###
        // #######################################################
        function initKeyboardListeners() {
            document.addEventListener('keydown', (e) => {
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') return;
                if (document.querySelector('.modal-overlay.show') && !document.getElementById('quickSelectModal').classList.contains('show')) return;
                if (isScanAdjustmentMode) return;

                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    if (isQuickSelectOpen) {
                        if (e.key === 'ArrowUp') { quickSelectIndex = (quickSelectIndex - 1 + quickSelectOptions.length) % quickSelectOptions.length; renderQuickSelect(); } 
                        else if (e.key === 'ArrowDown') { quickSelectIndex = (quickSelectIndex + 1) % quickSelectOptions.length; renderQuickSelect(); } 
                        else { closeQuickSelect(); }
                    } else {
                        if (e.key === 'ArrowUp') setCursor(cursor.day, cursor.period - 1);
                        if (e.key === 'ArrowDown') setCursor(cursor.day, cursor.period + 1);
                        if (e.key === 'ArrowLeft') setCursor(cursor.day - 1, cursor.period);
                        if (e.key === 'ArrowRight') setCursor(cursor.day + 1, cursor.period);
                    }
                    return;
                }
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (isQuickSelectOpen) { if (quickSelectOptions[quickSelectIndex]) { insertSubject(quickSelectOptions[quickSelectIndex]); closeQuickSelect(); } } 
                    else { advanceCursor(); }
                    return;
                }
                if (e.key === 'Delete' || e.key === 'Backspace') {
                     if (isQuickSelectOpen) { closeQuickSelect(); return; }
                     clearActiveCell(); return;
                }
                if (isQuickSelectOpen && /^[1-9]$/.test(e.key)) {
                    const idx = parseInt(e.key) - 1;
                    if (quickSelectOptions[idx]) { insertSubject(quickSelectOptions[idx]); closeQuickSelect(); }
                    return;
                }
                if (e.key === 'Escape') { if (isQuickSelectOpen) closeQuickSelect(); return; }
                if (/^[a-zA-Z]$/.test(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    if (document.querySelector('.modal-overlay.show')) return;
                    e.preventDefault(); const char = e.key.toUpperCase(); handleQuickSelect(char);
                }
            });
        }
        
        function handleQuickSelect(char) {
            const matches = allSubjects.filter(s => isSubjectVisible(s) && s.startsWith(char));
            if (matches.length === 0) return;
            else if (matches.length === 1) { insertSubject(matches[0]); closeQuickSelect(); } 
            else { openQuickSelect(matches); }
        }
        
        function openQuickSelect(matches) {
            quickSelectOptions = matches.slice(0, 9); quickSelectIndex = 0; isQuickSelectOpen = true; renderQuickSelect();
            const modal = document.getElementById('quickSelectModal'); const activeCell = document.querySelector('.active-cell');
            if (activeCell) {
                const rect = activeCell.getBoundingClientRect();
                modal.style.top = (rect.top + window.scrollY - 10) + 'px';
                modal.style.left = (rect.left + window.scrollX + (rect.width/2)) + 'px';
            }
            modal.classList.add('show');
        }

        function renderQuickSelect() {
             const content = document.getElementById('quickSelectContent');
             content.innerHTML = quickSelectOptions.map((s, idx) => `
                <div class="quick-option ${idx === quickSelectIndex ? 'selected' : ''}" onclick="insertSubject('${s}'); closeQuickSelect();">
                    <div class="quick-key">${idx + 1}</div>
                    <span class="font-bold text-gray-800">${s}</span>
                </div>
            `).join('');
        }
        
        function closeQuickSelect() {
            document.getElementById('quickSelectModal').classList.remove('show'); isQuickSelectOpen = false;
        }

        // #######################################################
        // ### ABSCHNITT: INIT & START (App Starten)           ###
        // #######################################################
        function init() {
            renderSubjects(); renderTimetable(); updateCursorVisuals(); renderClasses();
            document.getElementById('classInput').focus();
            ensureZUP(); 
            updateLiveStats(); 
            initKeyboardListeners();
            
            // Events f√ºr Scan Drag & Drop
            const body = document.getElementById('timetableBody');
            body.addEventListener('touchstart', handleDragStart, { passive: false });
            body.addEventListener('touchmove', handleDragMove, { passive: false });
            body.addEventListener('touchend', handleDragEnd);
            body.addEventListener('mousedown', handleDragStart);
            window.addEventListener('mousemove', handleDragMove);
            window.addEventListener('mouseup', handleDragEnd);
            
            if (!localStorage.getItem('stundenplan_tour_seen')) { setTimeout(startTour, 800); }
        }

        init();
    </script>
</body>
</html>
